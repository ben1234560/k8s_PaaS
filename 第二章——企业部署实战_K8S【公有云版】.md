## ç¬¬äºŒç« â€”â€”ä¼ä¸šéƒ¨ç½²å®æˆ˜_K8Sã€å…¬æœ‰äº‘ç‰ˆã€‘

### å‰è¨€ï¼ˆæ¨èä½¿ç”¨éå…¬æœ‰äº‘ç‰ˆï¼Œå› ä¸ºå¤šæ¬¡é€‚é…è¿‡åç»­å†…å®¹ï¼‰ï¼š

æ³¨ï¼šå…¬æœ‰äº‘ç‰ˆæœªæµ‹è¯•æ˜¯å¦é€‚é…ç¬¬ä¸‰ç« å¾€åå†…å®¹ï¼Œç†è®ºä¸Šæ˜¯å®Œå…¨å¯è¡Œçš„ã€‚

**è€ƒè™‘åˆ°éƒ¨åˆ†åŒå­¦æœºå™¨é…ç½®å¹¶æ— æ³•æ»¡è¶³å¤šå¼€VMwareï¼Œè¿™é‡Œæ¨å‡ºå…¬æœ‰äº‘ç‰ˆæœ¬ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰ã€‚å¿…é¡»æœ‰æ¢¯å­ï¼ˆvpn/ç¿»å¢™ï¼‰**

> **WHYï¼š**ä¸ºä»€ä¹ˆè¦æœ‰æ¢¯å­ï¼Œåé¢æˆ‘ä»¬ä¼šåˆ›å»ºä¸€äº›ç½‘ç«™ï¼Œè€Œå›½å†…åŸŸäº‘æœåŠ¡å™¨åˆ›å»ºçš„ç½‘ç«™éœ€è¦ICPå¤‡æ¡ˆï¼Œæ¯æ¬¡å¤‡æ¡ˆéƒ½éœ€è¦ç­‰å®¡æ‰¹éå¸¸éº»çƒ¦ã€‚è€Œå›½å¤–åŸŸäº‘æœåŠ¡å™¨åˆ›å»ºçš„ç½‘ç«™åˆ™ä¸éœ€è¦å¤‡æ¡ˆï¼Œç”¨èµ·æ¥éå¸¸èˆ’æœã€‚
>
> <img src="assets/WX20230511-145214@2x.png" alt="image-ICPFiling" style="zoom:25%;" />
>
> **HOWï¼š**æ¢¯å­æ¨èlestvpn(éå¹¿å‘Šï¼Œè¿™ä¸ªä¸€ä¸ªæœˆè¦40å¤šrmbï¼Œèƒ½é€‰ä»£ç†åœ°å€æˆ‘å› ä¸ºä¹Ÿç”¨chatGPTæ‰€ä»¥å¼€äº†ï¼Œæœ‰æ›´ä¾¿å®œçš„ä¸€å®šè¦æ¨èæˆ‘ğŸ˜­ï¼Œmac/windowéƒ½æµ‹è¿‡å¯ä»¥ç”¨)
>
> ä¸‹è½½é“¾æ¥ï¼ˆæ¨èä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼‰ï¼šhttps://bitbucket.org/letsgogo/letsgogo_19/src/master/README.md 
>
> å¤‡ç”¨é“¾æ¥ï¼ˆæ¨èä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼‰ï¼šhttps://github.com/LetsGo666/LetsGo_4
>
> å®‰è£…åæ‰“å¼€å¡«å†™æˆ‘çš„IDï¼š118149732 ä½ è¿˜èƒ½å¤šå¾—3å¤©ä¼šå‘˜ï¼ï¼ˆå¯ä»¥è·Ÿæœ‹å‹äº’ç›¸æ¨èäº’ç›¸å¾—å…è´¹å¤©æ•°ï¼‰



##### å¦‚æœä½ æ˜¯æ–°æ‰‹ï¼Œæœºå™¨çš„åå­—åŠå„ç§è´¦æˆ·å¯†ç ä¸€å®šè¦å’Œæˆ‘çš„ä¸€æ ·ï¼Œå…ˆå­¦ä¸€éï¼Œå†è‡ªå·±æ”¹

> **WHAT**ï¼šç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetesçš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetesæä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§æœºåˆ¶
>
> **WHY**ï¼šä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ç®¡ç†dockerå®¹å™¨æœ€ä¸»æµçš„ç¼–æ’å·¥å…·

- Pod
  - Podæ˜¯K8Sé‡Œèƒ½å¤Ÿè¢«è¿è¡Œçš„æœ€å°çš„é€»è¾‘å•å…ƒï¼ˆåŸå­å•å…ƒï¼‰
  - 1ä¸ªPodé‡Œé¢å¯ä»¥è¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œå®ƒä»¬å…±äº«UTS+NET+IPCåç§°ç©ºé—´
  - å¯ä»¥æŠŠPodç†è§£æˆè±Œè±†èšï¼Œè€ŒåŒä¸€Podå†…çš„æ¯ä¸ªå®¹å™¨æ˜¯ä¸€é¢—é¢—è±Œè±†
  - ä¸€ä¸ªPodé‡Œè¿è¡Œå¤šä¸ªå®¹å™¨ï¼Œåˆå«è¾¹è½¦ï¼ˆSideCarï¼‰æ¨¡å¼
- Podæ§åˆ¶å™¨ï¼ˆå…³äºæ›´å¤š<a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#%E5%88%9D%E8%AF%86pod">åˆè¯†Pod</a>ï¼‰
  - Podæ§åˆ¶å™¨æ˜¯Podå¯åŠ¨çš„ä¸€ç§æ¨¡æ¿ï¼Œç”¨æ¥ä¿è¯åœ¨K8Sé‡Œå¯åŠ¨çš„Podå§‹ç»ˆæŒ‰ç…§äººä»¬çš„é¢„æœŸè¿è¡Œï¼ˆå‰¯æœ¬æ•°ã€ç”Ÿå‘½å‘¨æœŸã€å¥åº·çŠ¶æ€æ£€æŸ¥...ï¼‰
  - Podå†…æä¾›äº†ä¼—å¤šçš„Podæ§åˆ¶å™¨ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š
    - Deployment
    - DaemonSet
    - ReplicaSet
    - StatefulSet
    - Job
    - Cronjob
- Name
  - ç”±äºK8Så†…éƒ¨ï¼Œä½¿ç”¨â€œèµ„æºâ€æ¥å®šä¹‰æ¯ä¸€ç§é€»è¾‘æ¦‚å¿µï¼ˆåŠŸèƒ½ï¼‰ï¼Œæ•…æ¯ç§â€œèµ„æºâ€ï¼Œéƒ½åº”è¯¥æœ‰è‡ªå·±çš„â€œåç§°â€
  - â€œèµ„æºâ€æœ‰apiç‰ˆæœ¬ï¼ˆapiVersionï¼‰ç±»åˆ«ï¼ˆkindï¼‰ã€å…ƒæ•°æ®ï¼ˆmetadataï¼‰ã€å®šä¹‰æ¸…å•ï¼ˆspecï¼‰ã€çŠ¶æ€ï¼ˆstatusï¼‰ç­‰é…ç½®ä¿¡æ¯
  - â€œåç§°â€é€šå¸¸å®šä¹‰åœ¨â€œèµ„æºâ€çš„â€œå…ƒæ•°æ®â€ä¿¡æ¯é‡Œ
- <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Docker%E5%9F%BA%E7%A1%80.md#%E5%85%B3%E4%BA%8Enamespace">namespace</a>
  - éšç€é¡¹ç›®å¢å¤šã€äººå‘˜å¢åŠ ã€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼Œéœ€è¦ä¸€ç§èƒ½å¤Ÿéš”ç¦»K8Så†…å„ç§â€œèµ„æºâ€çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯åç§°ç©ºé—´
  - åç§°ç©ºé—´å¯ä»¥ç†è§£ä¸ºK8Så†…éƒ¨çš„è™šæ‹Ÿé›†ç¾¤ç»„
  - ä¸åŒåç§°ç©ºé—´å†…çš„â€œèµ„æºâ€åç§°å¯ä»¥ç›¸åŒï¼Œç›¸åŒåç§°ç©ºé—´å†…çš„åŒç§â€œèµ„æºâ€ã€â€œåç§°â€ä¸èƒ½ç›¸åŒ
  - åˆç†çš„ä½¿ç”¨K8Såç§°ç©ºé—´ï¼Œä½¿å¾—é›†ç¾¤ç®¡ç†å‘˜èƒ½å¤Ÿæ›´å¥½çš„å¯¹äº¤ä»˜åˆ°K8Sé‡Œçš„æœåŠ¡è¿›è¡Œåˆ†ç±»ç®¡ç†å’Œæµè§ˆ
  - K8Så†…é»˜è®¤å­˜åœ¨çš„åç§°ç©ºé—´æœ‰ï¼šdefaultã€kube-systemã€kube-public
  - æŸ¥è¯¢K8Sé‡Œç‰¹å®šâ€œèµ„æºâ€è¦å¸¦ä¸Šç›¸åº”çš„åç§°ç©ºé—´
- Label
  - æ ‡ç­¾æ˜¯K8Sç‰¹è‰²çš„ç®¡ç†æ–¹å¼ï¼Œä¾¿äºåˆ†ç±»ç®¡ç†èµ„æºå¯¹è±¡
  - ä¸€ä¸ªæ ‡ç­¾å¯ä»¥å¯¹åº”å¤šä¸ªèµ„æºï¼Œä¸€ä¸ªèµ„æºä¹Ÿå¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå®ƒä»¬æ˜¯å¤šå¯¹å¤šçš„å…³ç³»
  - ä¸€ä¸ªèµ„æºæ‹¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œå¯ä»¥å®ç°ä¸åŒç»´åº¦çš„ç®¡ç†
  - æ ‡ç­¾çš„ç»„æˆï¼škey=value
  - ä¸æ ‡ç­¾ç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä¸€ç§â€œæ³¨è§£â€ï¼ˆannotationsï¼‰
- Labelé€‰æ‹©å™¨
  - ç»™èµ„æºæ‰“ä¸Šæ ‡ç­¾åï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è¿‡æ»¤æŒ‡å®šçš„æ ‡ç­¾
  - æ ‡ç­¾é€‰æ‹©å™¨ç›®å‰æœ‰ä¸¤ä¸ªï¼šåŸºäºç­‰å€¼å…³ç³»ï¼ˆç­‰äºã€ä¸ç­‰äºï¼‰å’ŒåŸºäºé›†åˆå…³ç³»ï¼ˆå±äºã€ä¸å±äºã€å­˜åœ¨ï¼‰
  - è®¸å¤šèµ„æºæ”¯æŒå†…åµŒæ ‡ç­¾é€‰æ‹©å™¨å­—æ®µ
    - matchLabels
    - matchExpressions
- Service
  - åœ¨K8Sçš„ä¸–ç•Œé‡Œï¼Œè™½ç„¶æ¯ä¸ªPodéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå•ç‹¬çš„IPåœ°å€ï¼Œä½†è¿™ä¸ªIPåœ°å€ä¼šéšç€Podçš„é”€æ¯è€Œæ¶ˆå¤±
  - Serviceï¼ˆæœåŠ¡ï¼‰å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒæ¦‚å¿µ
  - ä¸€ä¸ªServiceå¯ä»¥çœ‹ä½œä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„Podçš„å¯¹å¤–è®¿é—®æ¥å£
  - Serviceä½œç”¨ä¸å“ªäº›Podæ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å®šä¹‰çš„
- Ingress
  - Ingressæ˜¯K8Sé›†ç¾¤é‡Œå·¥ä½œåœ¨OSIç½‘ç»œå‚è€ƒæ¨¡å‹ä¸‹ï¼Œç¬¬7å±‚çš„åº”ç”¨ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£
  - Serviceåªèƒ½è¿›è¡ŒL4æµé‡è°ƒåº¦ï¼Œè¡¨ç°å½¢å¼æ˜¯ip+port
  - Ingressåˆ™å¯ä»¥è°ƒåº¦ä¸åŒä¸šåŠ¡åŸŸã€ä¸åŒURLè®¿é—®è·¯å¾„çš„ä¸šåŠ¡æµé‡

ç®€å•ç†è§£ï¼šPodå¯è¿è¡Œçš„åŸå­ï¼Œnameå®šä¹‰åå­—ï¼Œnamespaceåç§°ç©ºé—´ï¼ˆæ”¾ä¸€å †åå­—ï¼‰ï¼Œlabelæ ‡ç­¾ï¼ˆå¦å¤–çš„åå­—ï¼‰ï¼Œserviceæä¾›æœåŠ¡ï¼Œingressé€šä¿¡

### K8Sæ¶æ„å›¾ï¼ˆå¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„PaaSæœåŠ¡ï¼Œè€Œæ˜¯IaaSæœåŠ¡ï¼‰

![1582188308711](assets/1582188308711.png)

> **kubectl**ï¼šKubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œæ¥å£
>
> **API Server**ï¼šçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å¯¹æ ¸å¿ƒå¯¹è±¡ï¼ˆä¾‹å¦‚ï¼šPodï¼ŒServiceï¼ŒRCï¼‰çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼ŒåŒæ—¶ä¹Ÿæ˜¯é›†ç¾¤å†…æ¨¡å—ä¹‹é—´æ•°æ®äº¤æ¢çš„æ¢çº½
>
> **Etcd**ï¼šåŒ…å«åœ¨ APIServer ä¸­ï¼Œç”¨æ¥å­˜å‚¨èµ„æºä¿¡æ¯
>
> **Controller Manager **ï¼šè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰
>
> **Scheduler**ï¼šè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šã€‚å¯ä»¥é€šè¿‡è¿™äº›æœ‰æ›´æ·±çš„äº†è§£ï¼š
>
> - <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md">Kubernetesè°ƒåº¦æœºåˆ¶</a>
> - <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86">Kubernetesçš„èµ„æºæ¨¡å‹ä¸èµ„æºç®¡ç†</a>
> - <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubernetes%E9%BB%98%E8%AE%A4%E7%9A%84%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5">Kubernetesé»˜è®¤çš„è°ƒåº¦ç­–ç•¥</a>
> - <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#%E8%B0%83%E5%BA%A6%E5%99%A8%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E4%B8%8E%E5%BC%BA%E5%88%B6%E6%9C%BA%E5%88%B6">è°ƒåº¦å™¨çš„ä¼˜å…ˆçº§ä¸å¼ºåˆ¶æœºåˆ¶</a>
>
> **kube-proxy**ï¼šè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
>
> **Kubelet**ï¼šåœ¨Kubernetesä¸­ï¼Œåº”ç”¨å®¹å™¨å½¼æ­¤æ˜¯éš”ç¦»çš„ï¼Œå¹¶ä¸”ä¸è¿è¡Œå…¶çš„ä¸»æœºä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œè¿™æ˜¯å¯¹åº”ç”¨è¿›è¡Œç‹¬ç«‹è§£è€¦ç®¡ç†çš„å…³é”®ç‚¹ã€‚[Kubeletå·¥ä½œåŸç†è§£æ](https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E8%B0%83%E5%BA%A6%E6%9C%BA%E5%88%B6.md#kubelet)
>
> **Node**ï¼šè¿è¡Œå®¹å™¨åº”ç”¨ï¼Œç”±Masterç®¡ç†

### æˆ‘ä»¬éƒ¨ç½²çš„K8Sæ¶æ„å›¾

![1584700891603](assets/1584700891603.png)

> å¯ä»¥ç®€å•ç†è§£æˆï¼š
>
> 11æœºå™¨ï¼šåå‘ä»£ç†
>
> 12æœºå™¨ï¼šåå‘ä»£ç†
>
> 21æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆå³æœåŠ¡ç¾¤éƒ½æ˜¯è·‘åœ¨21å’Œ22ä¸Šï¼‰
>
> 22æœºå™¨ï¼šä¸»æ§+è¿ç®—èŠ‚ç‚¹ï¼ˆç”Ÿäº§ä¸Šæˆ‘ä»¬ä¼šæŠŠä¸»æ§å’Œè¿ç®—åˆ†å¼€ï¼‰
>
> 200æœºå™¨ï¼šè¿ç»´ä¸»æœºï¼ˆæ”¾å„ç§æ–‡ä»¶èµ„æºï¼‰
>
> è¿™æ ·æ§èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œè¿ç®—èŠ‚ç‚¹æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å°å‹çš„åˆ†å¸ƒå¼ï¼Œç°åœ¨ä½ å¯èƒ½æ²¡åŠæ³•ç†è§£è¿™äº›å†…å®¹ï¼Œæˆ‘ä»¬æ¥ç€åšä¸‹å»ï¼Œæ…¢æ…¢çš„ï¼Œä½ å°±ç†è§£äº†
>
> è¿™æ˜¯ç†è®ºä¸Šçš„æ¶æ„ï¼Œè€ƒè™‘åˆ°å…¬æœ‰äº‘å¯¹ç½‘ç»œçš„é™åˆ¶ç­‰é—®é¢˜ï¼ˆå¦‚ipv6ä¸èƒ½éšæ„å¢åŠ ï¼‰ï¼Œ21ã€22æœºå™¨ä¹Ÿä¼šè¿½åŠ åå‘ä»£ç†ã€‚

### å®éªŒæœºå™¨å®‰è£…è¯¦è§£

æˆ‘ä»¬å°†ç”³è¯·5ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾

|      | æ•´ä½“  | 11æœºå™¨ | 12æœºå™¨ | 21æœºå™¨ | 22æœºå™¨ | 200æœºå™¨ |
| ---- | ----- | ------ | ------ | ------ | ------ | ------- |
| ä½é… | 4C32G | 2C2G   | 2C2G   | 2C8G   | 2C8G   | 2C2G    |
| æ ‡é… | 8C64G | 2C4G   | 2C4G   | 2C16G  | 2C16G  | 2C2G    |

> ä½é…èƒ½å¤Ÿæ»¡è¶³Jenkinsä¹‹å‰çš„å†…å®¹ï¼Œåšåˆ°Jenkinsçš„æ—¶å€™å°±å·²ç»å¾ˆå¡äº†ï¼Œåˆ°æ—¶å€™å†è¿½åŠ è´­ä¹°æ–°çš„é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥è´­ä¹°æ ‡é…ï¼Œå‰æœŸæˆ‘è¿˜æ˜¯å¸Œæœ›å„ä½èƒ½åœ¨ç†è§£ä¸ŠèŠ±äº›æ—¶é—´ï¼Œæ…¢æ…¢çš„æ“ä½œï¼Œå¦åˆ™æŠ¥é”™éƒ½ä¸çŸ¥é“æ€ä¹ˆè§£å†³

### å¦‚ä½•è´­ä¹°å…¬æœ‰äº‘æœºå™¨ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰

> æ³¨ï¼šæœªé€‰çš„åˆ™æ˜¯é»˜è®¤é€‰é¡¹ã€‚

å¦‚ä¸‹å›¾ï¼Œé€‰æ‹©â€œè‡ªå®šä¹‰è´­ä¹°â€ã€â€œæŠ¢å å¼å®ä¾‹â€ï¼ˆè¿™é‡Œä½¿ç”¨æŠ¢å å¼å³å¯/çœé’±ï¼Œæ‹…å¿ƒè¢«å›æ”¶çš„å¯ä»¥é€‰æ‹©æŒ‰é‡ä»˜è´¹ï¼‰ã€â€œæ–°åŠ å¡â€æˆ–å…¶å®ƒå¤–ç½‘æœåŠ¡å™¨åœ°åŸŸï¼ˆå¤–ç½‘æœåŠ¡å™¨ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ç½‘ç«™ç­‰æ—¶ä¸éœ€è¦å¤‡æ¡ˆ/æœ€å¥½å‡†å¤‡ä¸ªæ¢¯å­ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜æ¢¯å­æ˜¯å¿…å¤‡çš„ï¼‰ã€â€œå¯ç”¨åŒºâ€ï¼ˆå¿…é¡»é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå¦‚æˆ‘é€‰çš„å¯ç”¨åŒºBï¼Œä¸èƒ½éšæœºåˆ†é…ï¼Œå¦åˆ™å¤šå°æœºå™¨çš„å†…ç½‘ipä¸ä¸€è‡´ï¼‰

![image-è´­ä¹°äº‘æœåŠ¡å™¨](assets/WX20230511-144757@2x.png)

> **WHYï¼š**ä¸ºä»€ä¹ˆé€‰æ–°åŠ å¡ï¼Œå› ä¸ºæˆ‘çš„æ¢¯å­å¯ä»¥åˆ°æ–°åŠ å¡ï¼Œä½ é€‰ä½ èƒ½ä»£ç†çš„å¤–ç½‘åœ°å€å³å¯
>
> <img src="assets/WX20230511-150425@2x.png" alt="image-æ¢¯å­ä»£ç†åœ°å€" style="zoom:33%;" align="left"/>

é€‰æ‹©â€œå…±äº«å‹â€ï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©é€šç”¨å‹ï¼Œå…±äº«å‹ä¼šæ›´ä¾¿å®œï¼‰ã€é€‰æ‹©2æ ¸8Gå†…å­˜çš„é…ç½®ï¼Œ

![image-é€‰æ‹©æœºå™¨é…ç½®](assets/WX20230511-150009@2x.png)

é€‰æ‹©CentOSï¼Œ7.6ç‰ˆæœ¬

![image-é€‰æ‹©ç³»ç»Ÿç‰ˆæœ¬](assets/WX20230511-150553@2x.png)

ç½‘ç»œåˆ†é…å…¬ç½‘IPv4åœ°å€ï¼Œé»˜è®¤é€‰æ‹©ï¼Œå…¶å®ƒä¸å˜ï¼Œè¿™æ ·åˆ›å»ºä¸‹æ¥çš„æœåŠ¡å™¨æ˜¯å…¬ç”¨åŒä¸€å®‰å…¨ç»„é…ç½®ï¼Œå¦‚æœé’±å…è®¸çš„è¯æŠŠç½‘é€Ÿå¼€åˆ°æœ€å¤§

é€‰æ‹©â€œè‡ªå®šä¹‰å¯†ç â€œï¼Œå»ºè®®è®¾ç½®ç›¸å¯¹å¤æ‚çš„å¯†ç ï¼Œå¦‚åŒ…å«å¤§å°å†™ï¼Œå¦åˆ™å®¹æ˜“è¢«æ”»ç ´ä½¿ç”¨

![image-è‡ªå®šä¹‰å¯†ç ](assets/WX20230511-150737@2x.png)

æœ€ç»ˆè®¢å•å†…å®¹ï¼Œæ³¨æ„æ˜¯5å°2C8Gï¼Œä¸€å°æ—¶ä»…éœ€0.2

![image-ç»“ç®—é¡µé¢](assets/WX20230511-150820@2x.png)

è´­ä¹°å®Œæˆåçš„å†…å®¹ï¼Œå»ºè®®ç»™æ¯ä¸ªå®ä¾‹è®¾ç½®èŠ‚ç‚¹å«ä¹‰ï¼Œå¦‚ä¸‹å›¾çš„k8s_11ã€k8s_12

![image-å®ä¾‹åˆ—è¡¨](/Users/xueweiguo/Desktop/GitHub/k8s_PaaS/assets/WX20230511-151455@2x.png)

å¦‚ä¸‹æ˜¯æˆ‘çš„å†…ç½‘åŠèŠ‚ç‚¹å¯¹åº”æƒ…å†µ

> |        | 11æœºå™¨         | 12æœºå™¨         | 21æœºå™¨         | 22æœºå™¨         | 200æœºå™¨        |
> | ------ | -------------- | -------------- | -------------- | -------------- | -------------- |
> | å†…ç½‘ip | 172.27.139.122 | 172.27.139.119 | 172.27.139.118 | 172.27.139.120 | 172.27.139.121 |
>
> å¯ä»¥çœ‹åˆ°ç½‘æ®µåœ¨172.27.139.0/254ï¼Œæˆ‘çš„11æœºå™¨å†…ç½‘ipæ˜¯172.27.139.122ï¼Œåç»­å°†ä¼šæŒç»­ç”¨åˆ°ï¼Œä½ éœ€è¦å¡«æˆä½ è‡ªå·±çš„11æœºå™¨å†…ç½‘ip

### æœºå™¨å‰æœŸå‡†å¤‡

ä½¿ç”¨xshellæˆ–è€…è‡ªé€‰çš„shellè¿æ¥å·¥å…·ï¼Œ[xshellä¸‹è½½](https://xshell.en.softonic.com/download)

> å½“ç„¶æˆ‘ä¹Ÿæœ‰æä¾›è½¯ä»¶åŒ…ï¼šhttps://pan.baidu.com/s/1mkIzua1XQmew240XBbvuFA æå–ç ï¼š7p6h ã€‚é‡Œé¢è¿˜æœ‰Xftpï¼Œæ˜¯ç”¨æ¥è¿›è¡Œæœ¬åœ°ç”µè„‘å’Œè™šæ‹Ÿæœºçš„æ–‡ä»¶ä¼ è¾“

~~~
# å…¨éƒ¨æœºå™¨ï¼Œè®¾ç½®åå­—ï¼Œ11æ˜¯hdss7-11,12æ˜¯hdss7-12,ä»¥æ­¤ç±»æ¨
~]# hostnamectl set-hostname hdss7-11.host.com
~]# exit
# ä¸‹é¢çš„ä¿®æ”¹ï¼Œ11æœºå™¨å¯¹åº”11æœºå™¨çš„å†…ç½‘ipï¼Œ12å¯¹åº”12æœºå™¨çš„å†…ç½‘ipï¼Œä»¥æ­¤ç±»æ¨å…±ä¸¤å¤„ï¼šIPADDRã€GATEWAY
~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes
IPADDR=172.27.139.122
GATEWAY=172.27.139.254
NETMASK=255.255.255.0
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=eth0
DEVICE=eth0
IPV6_PEERNDS=yes
IPV6_PEERROUTES=yes
IPV6_PRIUACY=no

~]# systemctl restart network
# ç»“æŸpingå‘½ä»¤ç”¨ctrl+c(control+c)ï¼Œç”¨äºå‘é€ä¸­æ–­ä¿¡å·ç»™å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹
~]# ping baidu.com
~~~

> **ifcfg-eth0**ï¼šæœ‰äº›äººçš„æœºå™¨å¯èƒ½æ˜¯ifcfg-esn33ã€‚ä½¿ç”¨ifconfigæŸ¥çœ‹ï¼Œå‘½ä»¤è¾“å‡ºä¸­æ¯ä¸ªç½‘å¡æ¥å£éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œä¾‹å¦‚ "eth0"ã€"ens33" ç­‰
>
> **systemctl restart**ï¼šé‡å¯æŸä¸ªæœåŠ¡
>
> **ping**ï¼šç”¨äºæµ‹è¯•ç½‘ç»œè¿æ¥é‡çš„ç¨‹åº
>
> å…¬æœ‰äº‘ï¼ˆé˜¿é‡Œï¼‰çš„ifcfg-eth0åŸå†…å®¹å¦‚ä¸‹ï¼š
>
> DEVICE=eth0
> BOOTPROTO=dhcp
> ONBOOT=yes

<img src="assets/WX20230511-152352@2x.png" alt="image-å®æ“å›¾" style="zoom:50%;" align="left"/>



~~~
# å…¨éƒ¨æœºå™¨ï¼ŒæŸ¥çœ‹enforceæ˜¯å¦å…³é—­ï¼Œç¡®ä¿disabledçŠ¶æ€ï¼Œå½“ç„¶å¯èƒ½æ²¡æœ‰è¿™ä¸ªå‘½ä»¤
~]# getforce
# æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨3.8ä»¥ä¸Šç‰ˆæœ¬
~]# uname -a
# å…³é—­firewalld
~]# systemctl stop firewalld
# å®‰è£…epelæºåŠç›¸å…³å·¥å…·
~]# yum install epel-release wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils yum-utils -y
# æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ
~]# rpm -q epel-release wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils yum-utils
# out:
epel-release-7-14.noarch
wget-1.14-18.el7_6.1.x86_64
net-tools-2.0-0.25.20131004git.el7.x86_64
telnet-0.17-66.el7.x86_64
tree-1.6.0-10.el7.x86_64
nmap-6.40-19.el7.x86_64
sysstat-10.1.5-20.el7_9.x86_64
lrzsz-0.12.20-36.el7.x86_64
dos2unix-6.0.3-7.el7.x86_64
bind-utils-9.11.4-26.P2.el7_9.13.x86_64
yum-utils-1.1.31-54.el7_8.noarch
~~~

> **uname**:æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
>
> - **-a/-all**ï¼šæ˜¾ç¤ºå…¨éƒ¨
>
> **yum**ï¼šæä¾›äº†æŸ¥æ‰¾ã€å®‰è£…ã€åˆ é™¤æŸä¸€ä¸ªã€ä¸€ç»„ç”šè‡³å…¨éƒ¨è½¯ä»¶åŒ…çš„å‘½ä»¤
>
> - **install**ï¼šå®‰è£…
> - **-y**ï¼šå½“å®‰è£…è¿‡ç¨‹æç¤ºé€‰æ‹©å…¨éƒ¨ä¸º"yes"

<img src="assets/WX20230511-152710@2x.png" alt="image-å®æ“å›¾" style="zoom:50%;" align="left"/>

~~~
# å…¨éƒ¨æœºå™¨ï¼Œå®‰è£…åç»­éœ€è¦çš„æœåŠ¡å·¥å…·ï¼ˆæˆ‘å°±ä¸åŒºåˆ†æ¯ä¸ªæœºå™¨æ‰€éœ€çš„äº†ï¼Œåé¢ä¼šçœ‹åˆ°ï¼‰
# è¿½åŠ dockerçš„repoæº
~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# å®‰è£…åç»­æ‰€éœ€çš„è½¯ä»¶åŒ…
~]# yum install supervisor docker-compose nginx nginx-mod-stream supervisor keepalived deltarpm docker-ce -y
# æ£€æŸ¥å®‰è£…æƒ…å†µ
~]# rpm -q supervisor docker-compose nginx nginx-mod-stream 
# out:
supervisor keepalived deltarpm docker-ce
supervisor-3.4.0-1.el7.noarch
docker-compose-1.18.0-4.el7.noarch
nginx-1.20.1-10.el7.x86_64
nginx-mod-stream-1.20.1-10.el7.x86_64
supervisor-3.4.0-1.el7.noarch
keepalived-1.3.5-19.el7.x86_64
deltarpm-3.6-3.el7.x86_64
docker-ce-23.0.6-1.el7.x86_64
~~~



### K8Så‰ç½®å‡†å¤‡å·¥ä½œâ€”â€”bind9å®‰è£…éƒ¨ç½²ï¼ˆDNSæœåŠ¡ï¼‰

> **WHAT**ï¼šDNSï¼ˆåŸŸåç³»ç»Ÿï¼‰è¯´ç™½äº†ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªåŸŸå’ŒIPåœ°å€åšäº†ä¸€ä¸‹ç»‘å®šï¼Œå¦‚ä½ åœ¨é‡Œæœºå™¨é‡Œé¢è¾“å…¥ nslookup www.qq.comï¼Œå‡ºæ¥çš„Addressæ˜¯ä¸€å †IPï¼ŒIPæ˜¯ä¸å®¹æ˜“è®°çš„ï¼Œæ‰€ä»¥DNSè®©IPå’ŒåŸŸååšä¸€ä¸‹ç»‘å®šï¼Œè¿™æ ·ä½ è¾“å…¥åŸŸåå°±å¯ä»¥äº†
>
> **WHY**ï¼šæˆ‘ä»¬è¦ç”¨ingressï¼Œåœ¨K8Sé‡Œè¦åš7å±‚è°ƒåº¦ï¼Œè€Œä¸”æ— è®ºå¦‚ä½•éƒ½è¦ç”¨åŸŸåï¼ˆå¦‚ä¹‹å‰çš„é‚£ä¸ªç™¾åº¦é¡µé¢çš„åŸŸåï¼Œé‚£ä¸ªæ˜¯hostçš„æ–¹å¼ï¼‰ï¼Œä½†æ˜¯é—®é¢˜æ˜¯æˆ‘ä»¬æ€ä¹ˆç»™K8Sé‡Œçš„å®¹å™¨ç»‘hostï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åšä¸€ä¸ªDNSï¼Œç„¶åå®¹å™¨æœä»æˆ‘ä»¬çš„DNSè§£æè°ƒåº¦

~~~
# åœ¨11æœºå™¨ï¼š
~]# yum install bind -y
~]# rpm -qa bind
# out: bind-9.11.4-9.P2.el7.x86_64
# é…ç½®ä¸»é…ç½®æ–‡ä»¶ï¼Œ11æœºå™¨
~]# vi /etc/named.conf
listen-on port 53 { 172.27.139.122; };  # åŸæœ¬æ˜¯127.0.0.1ï¼Œæˆ‘çš„11å†…ç½‘ipæ˜¯172.29.238.166ï¼Œä½ å¡«ä½ çš„11å†…ç½‘ip
# listen-on-v6 port 53 { ::1; };  # éœ€è¦åˆ æ‰
allow-query     { any; };  # åŸæœ¬æ˜¯localhost
forwarders      { 172.27.139.254; };  #å¦å¤–æ·»åŠ çš„
dnssec-enable no;  # åŸæœ¬æ˜¯yes
dnssec-validation no;  # åŸæœ¬æ˜¯yes

# æ£€æŸ¥ä¿®æ”¹æƒ…å†µï¼Œæ²¡æœ‰æŠ¥é”™å³å¯ï¼ˆå³æ²¡æœ‰ä¿¡æ¯ï¼‰
~]# named-checkconf
~~~

> **rpm**ï¼šè½¯ä»¶åŒ…ç®¡ç†å™¨
>
> - **-qa**ï¼šæŸ¥çœ‹å·²å®‰è£…çš„æ‰€æœ‰è½¯ä»¶åŒ…
>
> **rpmå’Œyumå®‰è£…çš„åŒºåˆ«**ï¼šå‰è€…ä¸æ£€æŸ¥ç›¸ä¾æ€§é—®é¢˜ï¼Œåè€…æ£€æŸ¥ï¼ˆå³ç›¸å…³ä¾èµ–åŒ…ï¼‰
>
> **named.confæ–‡ä»¶å†…å®¹è§£æï¼š**
>
> - **listen-on**ï¼šç›‘å¬ç«¯å£ï¼Œæ”¹ä¸ºç›‘å¬åœ¨å†…ç½‘ï¼Œè¿™æ ·å…¶å®ƒæœºå™¨ä¹Ÿå¯ä»¥ç”¨
> - **allow-query**ï¼šå“ªäº›å®¢æˆ·ç«¯èƒ½é€šè¿‡è‡ªå»ºçš„DNSæŸ¥
> - **forwarders**ï¼šä¸Šçº§DNSæ˜¯ä»€ä¹ˆ

<img src="assets/WX20230511-153237@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />



~~~
# 11æœºå™¨ï¼Œç»éªŒï¼šä¸»æœºåŸŸä¸€å®šå¾—è·Ÿä¸šåŠ¡æ˜¯ä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ï¼Œå¦‚host.comï¼Œè€Œä¸šåŠ¡ç”¨çš„æ˜¯od.comï¼Œå› ä¸ºä¸šåŠ¡éšæ—¶å¯èƒ½å˜
# åŒºåŸŸé…ç½®æ–‡ä»¶ï¼ŒåŠ åœ¨æœ€ä¸‹é¢ï¼Œéœ€è¦ä¿®æ”¹ä¸¤å¤„ï¼šallow-update
~]# vi /etc/named.rfc1912.zones
zone "host.com" IN {
        type  master;
        file  "host.com.zone";
        allow-update { 172.27.139.122; };
};

zone "od.com" IN {
        type  master;
        file  "od.com.zone";
        allow-update { 172.27.139.122; };
};

~~~

<img src="assets/WX20230511-153512@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

> **æ³¨æ„ï¼š**å½“é…ç½®11æœºå™¨å†…ç½‘ipåï¼Œè¯¥æœºå™¨åº”ä¿å­˜è¿è¡ŒçŠ¶æ€ï¼Œé‡å¯åå…¶å®ƒæœºå™¨å¯èƒ½æ— æ³•è¿æ¥å¤–ç½‘ã€‚@https://github.com/xinzhuxianshengæ„Ÿè°¢å»ºè®®ï¼

é…ç½®åŸŸåè§£æçš„ç›¸å…³ä¿¡æ¯

~~~
# 11æœºå™¨ï¼š
# æ³¨æ„serialè¡Œçš„æ—¶é—´ï¼Œä»£è¡¨ä»Šå¤©çš„æ—¶é—´+ç¬¬ä¸€æ¡è®°å½•ï¼š20230511+01ï¼Œéœ€è¦ä¿®æ”¹serialã€å„ä¸ªipã€
7-11 ~]# vi /var/named/host.com.zone
$ORIGIN host.com.
$TTL 600	; 10 minutes
@       IN SOA	dns.host.com. dnsadmin.host.com. (
				2023051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
			NS   dns.host.com.
$TTL 60	; 1 minute
dns                A    172.27.139.122
HDSS7-11           A    172.27.139.122
HDSS7-12           A    172.27.139.119
HDSS7-21           A    172.27.139.118
HDSS7-22           A    172.27.139.120
HDSS7-200          A    172.27.139.121

7-11 ~]# vi /var/named/od.com.zone
$ORIGIN od.com.
$TTL 600	; 10 minutes
@   		IN SOA	dns.od.com. dnsadmin.od.com. (
				2023051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
				NS   dns.od.com.
$TTL 60	; 1 minute
dns                A    172.27.139.122

# çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰æŠ¥é”™
7-11 ~]# named-checkconf
7-11 ~]# systemctl start named
7-11 ~]# netstat -luntp|grep 53
~~~

> **TTL 600**ï¼šæŒ‡å®šIPåŒ…è¢«è·¯ç”±å™¨ä¸¢å¼ƒä¹‹å‰å…è®¸é€šè¿‡çš„æœ€å¤§ç½‘æ®µæ•°é‡
>
> - **10 minutes**ï¼šè¿‡æœŸæ—¶é—´10åˆ†é’Ÿ
>
> **SOA**ï¼šä¸€ä¸ªåŸŸæƒå¨è®°å½•çš„ç›¸å…³ä¿¡æ¯ï¼Œåé¢æœ‰5ç»„å‚æ•°åˆ†åˆ«è®¾å®šäº†è¯¥åŸŸç›¸å…³éƒ¨åˆ†
>
> - **dnsadmin.od.com.**  ä¸€ä¸ªå‡çš„é‚®ç®±
> - **serial**ï¼šè®°å½•çš„æ—¶é—´
>
> **$ORIGIN**ï¼šå³ä¸‹åˆ—çš„åŸŸåè‡ªåŠ¨è¡¥å……od.comï¼Œå¦‚dnsï¼Œå¤–é¢çœ‹æ¥æ˜¯dns.od.com
>
> **netstat -luntp**ï¼šæ˜¾ç¤º tcp,udp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µ

<img src="assets/WX20230511-153817@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 11æœºå™¨ï¼Œæ£€æŸ¥ä¸»æœºåŸŸæ˜¯å¦è§£æ
7-11 ~]# dig -t A hdss7-21.host.com @172.27.139.122 +short
# out: 172.27.139.118
# é…ç½®æœåŠ¡å™¨èƒ½ä½¿ç”¨è¿™ä¸ªé…ç½®ï¼Œåœ¨æœ€ä¸‹é¢è¿½åŠ 11æœºå™¨çš„å†…ç½‘ip
7-11 ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0
DNS1=172.27.139.122
7-11 ~]# systemctl restart network
# é‡å¯ç½‘ç»œåï¼Œé©¬ä¸Špingå¯èƒ½æ— æ³•è¿æ¥ï¼Œéœ€è¦ç­‰ä¸ªåç§’é’Ÿ
7-11 ~]# ping baidu.com
7-11 ~]# ping hdss7-21.host.com
~~~

> **dig -t A**ï¼šæŒ‡çš„æ˜¯æ‰¾DNSé‡Œæ ‡è®°ä¸ºAçš„ç›¸å…³è®°å½•ï¼Œè€Œåé¢ä¼šå¸¦ä¸Šç›¸å…³çš„åŸŸï¼Œå¦‚ä¸Šé¢çš„hdss7-21.host.comï¼Œä¸ºä»€ä¹ˆå¤–é¢é…äº†HDSS7-21åé¢è¿˜ä¼šè‡ªåŠ¨æ¥ä¸Š.host.comå°±æ˜¯å› ä¸º$ORIGINï¼Œåé¢åˆ™æ˜¯å¯¹åº”çš„IP
>
> - **+short**ï¼šè¡¨ç¤ºåªè¿”å›IP

<img src="assets/WX20230511-154100@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# åœ¨é11æœºå™¨ä¸Šï¼Œæœ€ä¸‹é¢è¿½åŠ dns1=11æœºå™¨å†…ç½‘ip
~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0
DNS1=172.27.139.122

~]# systemctl restart network
# è¯•ä¸‹ç½‘ç»œæ˜¯å¦æ­£å¸¸
~]# ping baidu.com
# å…¶å®ƒæœºå™¨å°è¯•ping7-11æœºå™¨æˆ–200æœºå™¨ç­‰ä»»æ„æœºå™¨ï¼Œè¿™æ—¶å€™çŸ­åŸŸåæ˜¯å¯ä»¥ä½¿ç”¨äº†
7-12 ~]# ping hdss7-11.host.com
7-12 ~]# ping hdss7-200.host.com
~~~

> è®©å…¶å®ƒæœºå™¨çš„DNSå…¨éƒ¨æ”¹æˆ11æœºå™¨çš„å¥½å¤„æ˜¯ï¼Œå…¨éƒ¨çš„æœºå™¨è®¿é—®å¤–ç½‘å°±åªæœ‰é€šè¿‡11ç«¯å£ï¼Œæ›´å¥½æ§åˆ¶

<img src="assets/WX20230511-154412@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

æœºå™¨å‡†å¤‡å·¥ä½œå®Œæˆ:tada:



### K8Så‰ç½®å·¥ä½œâ€”â€”å‡†å¤‡ç­¾å‘è¯ä¹¦ç¯å¢ƒ

> **WHAT**ï¼š è¯ä¹¦ï¼Œå¯ä»¥ç”¨æ¥å®¡è®¡ä¹Ÿå¯ä»¥ä¿éšœå®‰å…¨ï¼Œk8Sç»„ä»¶å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ™éœ€è¦æœ‰å¯¹åº”çš„è¯ä¹¦ï¼Œè¯ä¹¦çš„è¯¦è§£ä½ ä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šæœåˆ°ï¼Œè¿™é‡Œå°±ä¸ç»†ç»†è¯´æ˜äº†
>
> **WHY**ï¼šå½“ç„¶æ˜¯ä¸ºäº†è®©æˆ‘ä»¬çš„ç»„ä»¶èƒ½æ­£å¸¸è¿è¡Œ

~~~
# cfsslæ–¹å¼åšè¯ä¹¦ï¼Œéœ€è¦ä¸‰ä¸ªè½¯ä»¶ï¼ˆå¦‚æœç½‘ç»œæ— æ³•è¿é€šï¼Œåˆ™å‚è€ƒä¸‹é¢æˆ‘å·²ä¸‹è½½å¥½çš„è½¯ä»¶åŒ…ï¼‰ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬éƒ¨ç½²åœ¨200æœºå™¨:
200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
200 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
200 ~]# chmod +x /usr/bin/cfssl*
200 ~]# which cfssl
200 ~]# which cfssl-json
200 ~]# which cfssl-certinfo
~~~

> **wget**ï¼šä»ç½‘ç»œä¸Šè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶çš„è‡ªç”±å·¥å…·
>
> **chmod**ï¼šç»™å¯¹åº”çš„æ–‡ä»¶æ·»åŠ æƒé™ï¼ˆ[èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/linux/linux-comm-chmod.html)ï¼‰
>
> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·å¢åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™
>
> **which**ï¼šæŸ¥çœ‹ç›¸åº”çš„ä¸œè¥¿åœ¨å“ªé‡Œ

##### æŠ¥é”™ï¼šwgetæŠ¥é”™ç½‘ç»œé—®é¢˜

~~~
# é’ˆå¯¹ä¸‹è½½cfsslç½‘ç»œæ— æ³•è¿é€šçš„æƒ…å†µï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1ã€‚æ‰¾åˆ°åä¸ºâ€ç¬¬äºŒç« æ¶‰åŠçš„è½¯ä»¶åŒ…â€œä¸­çš„cfsslçš„3ä¸ªæ–‡ä»¶ï¼Œä¸Šä¼ åˆ°/rootç›®å½•ä¸‹
200 ~]# cp cfssl_linux-amd64 /usr/bin/cfssl
200 ~]# cp cfssljson_linux-amd64 /usr/bin/cfssl-json
200 ~]# cp cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
200 ~]# chmod +x /usr/bin/cfssl*
200 ~]# which cfssl
200 ~]# which cfssl-json
200 ~]# which cfssl-certinfo
~~~

<img src="assets/WX20230511-155452@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />



~~~
200 ~]# mkdir /opt/certs
200 ~]# cd /opt/certs
certs]# vi ca-csr.json
{
    "CN": "ben123123",
    "hosts": [
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ],
    "ca": {
        "expiry": "1752000h"
    }
}
certs]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca
certs]# cat ca.pem
# å¦‚æœä½ è¿™æ—¶å€™æ˜¾ç¤ºæ®µé”™è¯¯æˆ–è€…jsoné”™è¯¯ï¼Œå°±æ˜¯ä¹‹å‰å…‹éš†è™šæ‹Ÿæœºçš„æ—¶å€™200æœºå™¨åœ°å€å’Œåˆ«çš„æœºå™¨åœ°å€é‡å å†²çªäº†ï¼Œéœ€è¦é‡å»º200è™šæ‹Ÿæœº
~~~

> **cd **ï¼šåˆ‡æ¢å½“å‰å·¥ä½œç›®å½•åˆ° dirName
>
> - è¯­æ³•ï¼šcd [dirName]
>
> **mkdir**ï¼šå»ºç«‹åç§°ä¸º dirName ä¹‹å­ç›®å½•
>
> - è¯­æ³•ï¼šmkdir [-p] dirName
> - **-p:** ç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å»ºä¸€ä¸ªï¼Œå¦‚mkdir empty/empty1/empty2
>
> **cfssl**ï¼šè¯ä¹¦å·¥å…·
>
> - gencertï¼šç”Ÿæˆçš„æ„æ€
>
> **ca-csr.jsonè§£æï¼š**
>
> - CNï¼šCommon Nameï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘å€æ˜¯å¦åˆæ³•ï¼Œä¸€èˆ¬å†™åŸŸåï¼Œéå¸¸é‡è¦
> - STï¼šStateï¼Œçœ
> - Lï¼šLocalityï¼Œåœ°åŒº
> - Oï¼šOrganization Nameï¼Œç»„ç»‡åç§°
> - OUï¼šOrganization Unit Nameï¼Œç»„ç»‡å•ä½åç§°
>
> <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E4%B8%AD%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%AB%E4%B9%89%E5%92%8C%E7%94%A8%E6%B3%95">Podä¸­å‡ ä¸ªé‡è¦å­—æ®µçš„å«ä¹‰å’Œç”¨æ³•</a>

<img src="assets/WX20230511-155653@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />



### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²dockerç¯å¢ƒ

> **WHAT**ï¼šæ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„é•œåƒä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linuxæˆ–Windows æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚
>
> **WHY**ï¼šPodé‡Œé¢å°±æ˜¯ç”±æ•°ä¸ªdockerå®¹å™¨ç»„æˆï¼ŒPodæ˜¯è±Œè±†èšï¼Œdockerå®¹å™¨æ˜¯é‡Œé¢çš„è±†å­ã€‚

~~~
# å¦‚æˆ‘ä»¬æ¶æ„å›¾æ‰€ç¤ºï¼Œè¿ç®—èŠ‚ç‚¹æ˜¯21/22æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ— æ³•è¿è¡Œpodï¼‰ï¼Œè¿ç»´ä¸»æœºæ˜¯200æœºå™¨ï¼ˆæ²¡æœ‰dockeråˆ™æ²¡åŠæ³•ä¸‹è½½dockerå­˜å…¥ç§æœ‰ä»“åº“ï¼‰ï¼Œæ‰€ä»¥åœ¨ä¸‰å°æœºå™¨å®‰è£…ï¼ˆ21/22/200ï¼‰
# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
# ä¸Šé¢çš„ä¸‹è½½å¯èƒ½ç½‘ç»œæœ‰é—®é¢˜ï¼Œéœ€è¦å¤šè¯•å‡ æ¬¡ï¼Œè¿™äº›éƒ¨ç½²æˆ‘å·²ç»ä¸åŒæœºå™¨è¯•è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå®åœ¨ä¸è¡Œçš„ä½¿ç”¨ä¸‹é¢æä¾›çš„æŠ¥é”™è§£å†³æ–¹æ³•ã€‚
~]# mkdir -p /data/docker /etc/docker
# # æ³¨æ„ï¼Œ172.7.21.1ï¼Œè¿™é‡Œå¾—21æ˜¯æŒ‡åœ¨hdss7-21å¾—æœºå™¨ï¼Œå¦‚æœæ˜¯22å¾—æœºå™¨ï¼Œå°±æ˜¯172.7.22.1ï¼Œå…±ä¸€å¤„éœ€è¦æ”¹æœºå™¨åï¼š"bip": "172.7.21.1/24"
~]# vi /etc/docker/daemon.json
{
  "data-root": "/data/docker",
  "storage-driver": "overlay2",
  "insecure-registries": ["registry.access.redhat.com","quay.io","harbor.od.com"],
  "registry-mirrors": ["https://q2gr04ke.mirror.aliyuncs.com"],
  "bip": "172.7.21.1/24",
  "exec-opts": ["native.cgroupdriver=systemd"],
  "live-restore": true
}

~]# systemctl start docker
~]# docker version
~]# docker ps -a
~~~

> **mkdir -pï¼š**å‰é¢æœ‰è®²åˆ°è¿‡ï¼ˆä¸Šä¸€çº§ç›®å½•æ²¡æœ‰åˆ™åˆ›å»ºï¼‰ï¼Œè€Œè¿™æ¬¡åé¢å¸¦äº†ä¸¤ä¸ªç›®å½•ï¼Œæ„æ€æ˜¯åŒæ—¶åˆ›å»ºä¸¤ä¸ªç›®å½•
>
> **daemon.jsonï¼š**ä¸ºä»€ä¹ˆé…aliyuncsçš„ç¯å¢ƒï¼Œæ˜¯å› ä¸ºé»˜è®¤æ˜¯è¿æ¥åˆ°å¤–ç½‘çš„ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å›½å†…çš„é˜¿é‡Œäº‘é•œåƒæºï¼Œå½“ç„¶è¿˜æœ‰è…¾è®¯äº‘ç­‰
>
> **docker versionï¼š**æŸ¥çœ‹dockerçš„ç‰ˆæœ¬
>
> **daemon.jsonè§£æï¼š**é‡ç‚¹è¯´ä¸€ä¸‹è¿™ä¸ªä¸ºä»€ä¹ˆ10.4.7.21æœºå™¨å¯¹åº”ç€172.7.21.1/24ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°10çš„21å¯¹åº”å¾—æ˜¯172çš„21ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œå½“ä½ çš„podå‡ºç°é—®é¢˜æ—¶ï¼Œä½ å¯ä»¥é©¬ä¸Šå®šä½åˆ°æ˜¯åœ¨å“ªå°æœºå™¨å‡ºç°çš„é—®é¢˜ï¼Œæ˜¯21è¿˜æ˜¯22è¿˜æ˜¯å…¶å®ƒçš„ï¼Œè¿™ç‚¹åœ¨ç”Ÿäº§ä¸Šéå¸¸é‡è¦ï¼Œæœ‰æ—¶å€™ä½ çš„dashboardï¼ˆåé¢ä¼šå®‰è£…ï¼‰å®•æ‰äº†ï¼Œä½ æ²¡åŠæ³•åªèƒ½å»æœºå™¨æ‰¾ï¼Œè€Œè¿™æ—¶å€™ä½ åˆæ‰¾ä¸åˆ°çš„æ—¶å€™ï¼Œä½ è€æ¿ä¼šæ‹¿ä½ ç¥­å¤©çš„

##### æŠ¥é”™ï¼šcurl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun

æŠ¥é”™ä¿¡æ¯ï¼š

http://mirrors.cloud.aliyuncs.com/centos/7/updates/x86_64/Packages/libxml2-2.9.1-6.el7_9.6.x86_64.rpm: [Errno 14] curl#6 - "Could not resolve host: mirrors.cloud.aliyuncs.com; Unknown error"
Trying other mirror.

Error downloading packages:
  libxml2-2.9.1-6.el7_9.6.x86_64: [Errno 256] No more mirrors to try.
  python-kitchen-1.1.1-5.el7.noarch: [Errno 256] No more mirrors to try.
  yum-utils-1.1.31-54.el7_8.noarch: [Errno 256] No more mirrors to try.
  python-chardet-2.2.1-3.el7.noarch: [Errno 256] No more mirrors to try.
  libxml2-python-2.9.1-6.el7_9.6.x86_64: [Errno 256] No more mirrors to try.

åŸå› ï¼šyumæºå‡ºç°é—®é¢˜

è§£å†³æ–¹æ³•ï¼š

~~~
mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo  # è¿™ä¸€æ­¥å¿…é¡»æˆåŠŸï¼Œæ²¡æˆåŠŸçš„å†æ‰§è¡Œä¸€éå³å¯
yum update -y  # è¿™ä¸€æ­¥è€—æ—¶è¾ƒé•¿
yum install epel-release -y
yum install -y yum-utils
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install -y docker-ce
~~~

<img src="assets/WX20230511-162032@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />



### K8Så‰ç½®å·¥ä½œâ€”â€”éƒ¨ç½²harborä»“åº“

> **WHAT **ï¼šharborä»“åº“æ˜¯å¯ä»¥éƒ¨ç½²åˆ°æœ¬åœ°çš„ç§æœ‰ä»“åº“ï¼Œä¹Ÿå°±æ˜¯ä½ å¯ä»¥æŠŠé•œåƒæ¨åˆ°è¿™ä¸ªä»“åº“ï¼Œç„¶åéœ€è¦ç”¨çš„æ—¶å€™å†ä¸‹è½½ä¸‹æ¥ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼š1ã€ä¸‹è½½é€Ÿåº¦å¿«ï¼Œç”¨åˆ°çš„æ—¶å€™èƒ½é©¬ä¸Šä¸‹è½½ä¸‹æ¥2ã€ä¸ç”¨æ‹…å¿ƒé•œåƒæ”¹åŠ¨æˆ–è€…ä¸‹æ¶ç­‰ã€‚
>
> **WHY**ï¼šå› ä¸ºæˆ‘ä»¬çš„éƒ¨ç½²K8Sæ¶‰åŠåˆ°å¾ˆå¤šé•œåƒï¼Œåˆ¶ä½œç›¸å…³åŒ…çš„æ—¶å€™å¦‚æœç½‘é€Ÿé—®é¢˜ä¼šå¯¼è‡´å¤±è´¥é‡æ¥ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨å…¬å¸é‡Œä¹Ÿä¼šå»ºè‡ªå·±çš„ä»“åº“ï¼Œæ‰€ä»¥å¿…é¡»æŒ‰ç…§harborä»“åº“

~~~
# å¦‚æ¶æ„å›¾ï¼Œæˆ‘ä»¬å®‰è£…åœ¨200æœºå™¨ï¼š
200 ~]# mkdir /opt/src  && cd /opt/src
# å¯ä»¥å»è¿™ä¸ªåœ°å€ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨æˆ‘ç”¨çš„è½¯ä»¶åŒ…
https://github.com/goharbor/harbor/releases/tag/v1.8.3
200 src]# wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.3.tgz
7-200 src]# tar xf harbor-offline-installer-v1.8.3.tgz -C /opt/
~~~

> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶
>
> - **x**ï¼šè§£å‹
> - **f**ï¼š ä½¿ç”¨æ¡£æ¡ˆåå­—
> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•
> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·
>
> **å…³äºç‰ˆæœ¬**ï¼šä¸€èˆ¬äººéƒ½æ˜¯å–œæ¬¢ç”¨æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿæ”¯æŒæ¯”è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œä½†å¯¹äºå…¬å¸è€Œå·²ï¼Œç¨³å®šæ˜¯æœ€è¦ç´§çš„ï¼Œv1.8.3æ˜¯ç”¨çš„æ¯”è¾ƒç¨³å®šçš„ç‰ˆæœ¬ï¼Œè€Œåç»­çš„å„ä¸ªç»„ä»¶ä¹Ÿä¼šæœ‰æ›´åŠ æ–°çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥å°è¯•æ–°ç‰ˆæœ¬ï¼Œä½†æœ‰äº›ç”±äºå…¼å®¹é—®é¢˜ä¸èƒ½ç”¨æ–°çš„ï¼Œåç»­é‚£äº›ä¸èƒ½ç”¨æˆ‘ä¼šæ ‡è®°æ¸…æ¥šã€‚

~~~
# 200æœºå™¨ï¼š
200 src]# cd /opt/
200 opt]# mv harbor/ harbor-v1.8.3
200 opt]# ln -s /opt/harbor-v1.8.3/ /opt/harbor
200 opt]# cd harbor
200 harbor]# ll
# ä¿®æ”¹åŸŸåã€ç«¯å£ã€æŒ‚è½½å·åŠæ—¥å¿—å­˜æ”¾åœ°å€
200 harbor]# vi harbor.yml  # å¦‚æœè¿™é‡Œæ˜¯ç”¨çš„2.8.0ç‰ˆæœ¬ï¼Œåˆ™éœ€è¦cp harbor.yml.tmpl harbor.yml
hostname: harbor.od.com  # åŸreg.mydomain.com
http:
  port: 180  # åŸ80
data_volume: /data/harbor
location: /data/harbor/logs

200 harbor]# mkdir -p /data/harbor/logs
# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install docker-compose -y
200 harbor]# rpm -qa docker-compose
# out: docker-compose-1.18.0-4.el7.noarch
# yum install docker-compose åŒ…æ— æ³•ä¸‹è½½çš„ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹é¢æä¾›çš„æŠ¥é”™è§£å†³æ–¹æ³•
200 harbor]# ./install.sh
~~~

> **æç¤º**ï¼šharbor v2.3.3ç‰ˆæœ¬å®‰è£…ä¹Ÿéœ€è¦å°†httpsç›¸å…³çš„é…ç½®æ³¨é‡Šæ‰
>
> å¦‚å›¾#https:
>
> ![1635775214057](/Users/xueweiguo/Desktop/GitHub/k8s_PaaS/assets/1635775214057.png)
>
> æ„Ÿè°¢@https://github.com/xinzhuxiansheng
>
> **mv**ï¼šä¸ºæ–‡ä»¶æˆ–ç›®å½•æ”¹åã€æˆ–å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å…¶å®ƒä½ç½®ã€‚
>
> - è¿™é‡Œçš„å‘½ä»¤æ˜¯æœ‰æ–œæ çš„ï¼Œæ‰€ä»¥æ˜¯ç§»åŠ¨åˆ°æŸä¸ªç›®å½•ä¸‹
>
> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥
>
> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`
> - `**-sï¼š**è½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥`
>
> **harbor.ymlè§£æï¼š**
>
> - portä¸ºä»€ä¹ˆæ”¹æˆ180ï¼šå› ä¸ºåé¢æˆ‘ä»¬è¦è£…nginxï¼Œnginxç”¨çš„80ï¼Œæ‰€ä»¥è¦æŠŠå®ƒä»¬é”™å¼€
> - data_volumeï¼šæ•°æ®å·ï¼Œå³dockeré•œåƒæ”¾åœ¨å“ªé‡Œ
> - locationï¼šæ—¥å¿—æ–‡ä»¶
> - **./install.sh**ï¼šå¯åŠ¨shellè„šæœ¬

##### æŠ¥é”™ï¼šyum install docker-compose -yæŠ¥é”™No package docker-compose available.

ä½¿ç”¨æˆ‘æä¾›çš„å®˜æ–¹è½¯ä»¶åŒ…ï¼ˆæ”¾åœ¨ç™¾åº¦ç½‘ç›˜ï¼‰ï¼Œæ”¾åˆ°harborè·¯å¾„ä¸‹

~~~sh
200 harbor]# sudo cp docker-compose-Linux-x86_64 /usr/local/bin/docker-compose
200 harbor]# sudo chmod +x /usr/local/bin/docker-compose
200 harbor]# docker-compose --version
# out: docker-compose version 1.29.2, build 5becea4c
200 harbor]# ./install.sh
~~~

<img src="assets/WX20230511-165532@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

<img src="assets/WX20230511-165640@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />



~~~
# 200æœºå™¨ï¼š
200 harbor]# docker-compose ps
# out:
      Name                     Command               State             Ports          
--------------------------------------------------------------------------------------
harbor-core         /harbor/start.sh                 Up                               
harbor-db           /entrypoint.sh postgres          Up      5432/tcp                 
harbor-jobservice   /harbor/start.sh                 Up                               
harbor-log          /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514->10514/tcp
harbor-portal       nginx -g daemon off;             Up      80/tcp                   
nginx               nginx -g daemon off;             Up      0.0.0.0:180->80/tcp      
redis               docker-entrypoint.sh redis ...   Up      6379/tcp                 
registry            /entrypoint.sh /etc/regist ...   Up      5000/tcp                 
registryctl         /harbor/start.sh                 Up 
200 harbor]# docker ps -a
# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install nginx -y  # æŠ¥é”™çš„å‚è€ƒä¸‹é¢æŠ¥é”™å¯¹åº”çš„è§£å†³æ–¹æ³•

###ç›¸å…³æŠ¥é”™é—®é¢˜ï¼š
yumçš„æ—¶å€™æŠ¥ï¼š/var/run/yum.pid å·²è¢«é”å®šï¼ŒPID ä¸º 1610 çš„å¦ä¸€ä¸ªç¨‹åºæ­£åœ¨è¿è¡Œã€‚
å¦å¤–ä¸€ä¸ªç¨‹åºé”å®šäº† yumï¼›ç­‰å¾…å®ƒé€€å‡ºâ€¦â€¦
ç½‘ä¸Šç»Ÿä¸€çš„è§£å†³åŠæ³•ï¼šç›´æ¥åœ¨ç»ˆç«¯è¿è¡Œ rm -f /var/run/yum.pid å°†è¯¥æ–‡ä»¶åˆ é™¤ï¼Œç„¶åå†æ¬¡è¿è¡Œyumã€‚
###
~~~

##### æŠ¥é”™ï¼šyum install nginx -yæ²¡æœ‰å¯¹åº”åŒ…

~~~
200 ~]# yum install nginx -y
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
No package nginx available.
Error: Nothing to do
~~~

è§£å†³æ–¹æ³•

~~~
# ç¼–å†™nginx.repo
200 harbor]# sudo vi /etc/yum.repos.d/nginx.repo
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1

# ä¿å­˜é€€å‡ºåå³å¯å®‰è£…nginxäº†
200 harbor]# sudo yum install nginx -y
~~~



è§£å†³å®Œæ¥ç€èµ°

~~~
200 harbor]# vi /etc/nginx/conf.d/harbor.od.com.conf
server {
    listen       80;
    server_name  harbor.od.com;

    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}

200 harbor]# nginx -t
200 harbor]# systemctl start nginx
200 harbor]# systemctl enable nginx
~~~

> **nginx -t**ï¼šæµ‹è¯•*nginx*.confé…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¯­æ³•é”™è¯¯
>
> **systemctl enable nginx**ï¼šå¼€æœºè‡ªåŠ¨å¯åŠ¨

è¿½åŠ åŸŸåè§£æ

~~~
# åœ¨11æœºå™¨è§£æåŸŸåï¼š
~]# vi /var/named/od.com.zone
# æ³¨æ„serialå‰æ»šä¸€ä¸ªåºå·
# æœ€ä¸‹é¢æ·»åŠ åŸŸå
harbor             A    172.27.139.121
~]# systemctl restart named
~]# dig -t A harbor.od.com +short
# out:172.29.238.162
~~~

<img src="assets/WX20230511-163252@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 200æœºå™¨ä¸Šcurlï¼š
harbor]# curl harbor.od.com
~~~

> æ³¨æ„ï¼š
>
> getenforceå¾—æ˜¯å…³é—­çŠ¶æ€ï¼Œè€Œä¸æ˜¯enforcingï¼Œå¦åˆ™ä¼šæŠ¥502
> æš‚æ—¶å…³é—­setenforce 0
> æ°¸ä¹…å…³é—­ï¼Œæ”¹é…ç½®æ–‡ä»¶ vi /etc/selinux/config
> SELINUX=disabled

<img src="assets/WX20230511-163549@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

å…¬æœ‰äº‘çš„å®‰å…¨ç»„æ·»åŠ tcp 180ç«¯å£æƒé™

<img src="assets/WX20230511-164140@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

åœ¨æœ¬æœºï¼ˆwindow/macï¼‰hostsï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„ DNS åŸŸåè§£æï¼ˆç¡®ä¿èƒ½telneté€šï¼‰ï¼Œå¦‚ï¼š

~~~
å…¬ç½‘ip harbo.od.com  # å…¬ç½‘ipå¯¹åº”200æœºå™¨çš„å…¬ç½‘ip
~~~

[è®¿é—®harbor.od.com:180](harbor.od.com:180)

<img src="assets/WX20230511-190408@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

<img src="assets/WX20230512-095227@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
è´¦å·ï¼šadmin
å¯†ç ï¼šHarbor12345
æ–°å»ºä¸€ä¸ªpublicå…¬å¼€é¡¹ç›®ï¼Œç™»é™†æŠ¥é”™è¯·å‚è€ƒä¸‹é¢çš„æŠ¥é”™è§£å†³æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¦‚æœæ¥å£æ–¹å¼ä¹Ÿæ— æ³•è§£å†³ï¼Œç›´æ¥é‡è£…æ›´å¿«
~~~

![1578831458247](assets/1578831458247.png)

~~~
# 200æœºå™¨ï¼Œå°è¯•ä¸‹æ˜¯å¦èƒ½pushæˆåŠŸåˆ°harborä»“åº“
harbor]# docker pull nginx:1.7.9
harbor]# docker images|grep 1.7.9
harbor]# docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9
harbor]# docker login harbor.od.com
è´¦å·ï¼šadmin
å¯†ç ï¼šHarbor12345
harbor]# docker push harbor.od.com/public/nginx:v1.7.9
# æŠ¥é”™ï¼šå¦‚æœå‘ç°ç™»å½•ä¸ä¸Šå»äº†ï¼Œè¿‡ä¸€é˜µå­å†ç™»å½•å³å¯ï¼Œå¤§çº¦5åˆ†é’Ÿå·¦å³
~~~

![1578832524891](assets/1578832524891.png)

##### æŠ¥é”™ï¼šç”¨æ­£ç¡®çš„adminåŠå¯†ç ä»æç¤ºå¯†ç é”™è¯¯

æ’æŸ¥ï¼šcat /data/harbor/logs/* |grep -i erro

é‡æ–°å®‰è£…ä¸€æ¬¡harboræˆ–ç›´æ¥ç”¨å‘½ä»¤è¡Œæ“ä½œåˆ›å»ºpublic

~~~
# é’ˆå¯¹1.8.2ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬éœ€è¦æ–°ç‰ˆæœ¬çš„æ“ä½œæŒ‡ä»¤ï¼Œéƒ¨ç½²åapiæ§åˆ¶ä¸­å¿ƒåœ¨è¿™é‡Œhttp://harbor.od.com:180/devcenter
# åˆ›å»ºpublic
~]curl -u "admin:Harbor12345" -X POST "http://harbor.od.com/api/projects" -H "Content-Type: application/json" -d '{"project_name":"public","metadata":{"public":"true"}}'
# ç¡®è®¤æ˜¯å¦åˆ›å»ºæˆåŠŸ
~]curl -u "admin:Harbor12345" -X GET "http://harbor.od.com/api/projects"
~~~

<img src="assets/WX20230511-191809@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

æ£€æŸ¥æ¨é€nginxæ˜¯å¦æˆåŠŸ

~~~
# å¿…é¡»å·²ç»ä¸‹è½½å¥½jqäº†ï¼Œyum install jq -y
# è·å–publicçš„idï¼Œä¸€èˆ¬æ˜¯2
curl -u "admin:Harbor12345" -X GET "http://harbor.od.com/api/projects?name=public" | jq '.[0].project_id'
# ä½¿ç”¨id=2è¿›è¡Œapiæ¥å£çš„è°ƒç”¨
curl -u "admin:Harbor12345" -X GET "http://harbor.od.com/api/repositories?project_id=2" | jq '.[].name'
~~~

æˆåŠŸï¼Œæ­¤æ—¶ä½ å·²æˆåŠŸå»ºç«‹äº†è‡ªå·±çš„æœ¬åœ°ç§æœ‰ä»“åº“:tada:ï¼Œæˆ–è®¸ä½ ä¼šè€ƒè™‘å»ºç«‹è‡ªå·±çš„ç‹¬ç«‹ç«™ï¼Œenjoin!



### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹æœåŠ¡etcd

> æ³¨æ„, ä¸€å®šè¦åŒæ­¥æ¯ä¸ªè™šæ‹Ÿæœºçš„æ—¶é—´, æ—¶åŒºå’Œæ—¶é—´è¦ä¿æŒä¸€è‡´, å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„å‘½ä»¤æ¥æ“ä½œ, æœ€å¥½æ‰€æœ‰çš„è™šæ‹Ÿæœºéƒ½æ‰§è¡Œä¸€æ¬¡, æœ€å¥½çš„æ–¹æ³•æ˜¯å†™è¿›`/etc/rc.local`ä¸­

  ```bash
timedatectl set-timezone Asia/Shanghai
timedatectl set-ntp true
  ```

> **WHAT**ï¼šä¸€ä¸ªé«˜å¯ç”¨å¼ºä¸€è‡´æ€§çš„æœåŠ¡å‘ç°å­˜å‚¨ä»“åº“ï¼Œå…³äºæœåŠ¡å‘ç°ï¼Œå…¶æœ¬è´¨å°±æ˜¯çŸ¥é“äº†é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬udpå’Œtcpç«¯å£ï¼ˆå¦‚ä¸Šé¢éƒ¨ç½²çš„harborå°±æ˜¯ç›‘å¬180ç«¯å£ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚
>
> - **ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•**ï¼šåŸºäºRaftç®—æ³•çš„etcdå¤©ç”Ÿå°±æ˜¯è¿™æ ·
> - **ä¸€ç§æ³¨å†ŒæœåŠ¡å’Œç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€çš„æœºåˆ¶**ï¼šåœ¨etcdä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®`key TTL`ï¼ˆTTLä¸Šé¢æœ‰è®²åˆ°ï¼‰ï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœ
> - **ä¸€ç§æŸ¥æ‰¾å’Œè¿æ¥æœåŠ¡çš„æœºåˆ¶**ï¼šé€šè¿‡åœ¨etcdæŒ‡å®šçš„ä¸»é¢˜ä¸‹æ³¨å†Œçš„æœåŠ¡ä¹Ÿèƒ½åœ¨å¯¹åº”çš„ä¸»é¢˜ä¸‹æŸ¥æ‰¾åˆ°ï¼Œä¸ºäº†ç¡®ä¿è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡æœºå™¨ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ªProxyæ¨¡å¼çš„etcdï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿èƒ½è®¿é—®etcdé›†ç¾¤çš„æœåŠ¡éƒ½èƒ½äº’ç›¸è¿æ¥
>
> **WHY**ï¼šæˆ‘ä»¬éœ€è¦è®©æœåŠ¡å¿«é€Ÿé€æ˜åœ°æ¥å…¥åˆ°è®¡ç®—é›†ç¾¤ä¸­ï¼Œè®©å…±äº«é…ç½®ä¿¡æ¯å¿«é€Ÿè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨å‘ç°

çœ‹æˆ‘ä»¬çš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨12/21/22æœºå™¨éƒ½éƒ¨ç½²äº†etcd

![1584701032598](assets/1584701032598.png)

~~~
# æˆ‘ä»¬å¼€å§‹åˆ¶ä½œè¯ä¹¦ï¼Œ200æœºå™¨ï¼š
certs]# cd /opt/certs/
certs]# vi /opt/certs/ca-config.json
{
    "signing": {
        "default": {
            "expiry": "1752000h"
        },
        "profiles": {
            "server": {
                "expiry": "1752000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth"
                ]
            },
            "client": {
                "expiry": "1752000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "client auth"
                ]
            },
            "peer": {
                "expiry": "1752000h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            }
        }
    }
}

# ä¸‹é¢hostsæ·»åŠ 11ã€12ã€21ã€22æœºå™¨çš„å†…ç½‘ip
certs]# vi etcd-peer-csr.json
{
    "CN": "k8s-etcd",
    "hosts": [
        "172.27.139.122",
        "172.27.139.119",
        "172.27.139.118",
        "172.27.139.120"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ]
}

certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer
certs]# ll
~~~

> å…³äºè¿™äº›jsonæ–‡ä»¶æ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„ï¼Œç­”æ¡ˆï¼šå®˜ç½‘æŠ„çš„ç„¶åä¿®æ”¹ï¼Œè¿™äº›æ²¡ä»€ä¹ˆé‡è¦çš„ä½ ä¹Ÿä¸éœ€è¦å¤ªåœ¨æ„ï¼Œåé¢é‡è¦çš„ä¼šè¯´æ˜æ˜¯ä»å“ªé‡ŒæŠ„å‡ºæ¥çš„
>
> **ca-config.jsonè§£æï¼š**
>
> - expiryï¼šæœ‰æ•ˆæœŸä¸º200å¹´
> - profiles-serverï¼šå¯åŠ¨serverçš„æ—¶å€™éœ€è¦é…ç½®è¯ä¹¦
> - profiles-clientï¼šclientå»è¿æ¥serverçš„æ—¶å€™éœ€è¦è¯ä¹¦
> - profiles-peerï¼šåŒå‘è¯ä¹¦ï¼ŒæœåŠ¡ç«¯æ‰¾å®¢æˆ·ç«¯éœ€è¦è¯ä¹¦ï¼Œå®¢æˆ·ç«¯æ‰¾æœåŠ¡ç«¯éœ€è¦è¯ä¹¦
>
> **etcd-peer-csrè§£æï¼š**
>
> - hostsï¼šetcdæœ‰å¯èƒ½éƒ¨ç½²åˆ°å“ªäº›ç»„ä»¶çš„IPéƒ½è¦å¡«è¿›æ¥
>
> **cfssl gencert**ï¼šç”Ÿæˆè¯ä¹¦

<img src="assets/WX20230512-100209@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 12/21/22æœºå™¨ï¼Œå®‰è£…etcdï¼š
~]# mkdir /opt/src
~]# cd /opt/src/
# åˆ›å»ºç”¨æˆ·
src]# useradd -s /sbin/nologin -M etcd
src]# id etcd

# åˆ°GitHubä¸‹è½½æˆ–è€…ç›´æ¥ç”¨æˆ‘ç»™å¾—å®‰è£…åŒ… https://github.com/etcd-io/etcd/releases/tag/v3.1.20ï¼Œç™¾åº¦äº‘https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1
src]# wget https://github.com/etcd-io/etcd/releases/download/v3.1.20/etcd-v3.1.20-linux-amd64.tar.gz
src]# tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt
src]# cd /opt
opt]# mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20
opt]# ln -s /opt/etcd-v3.1.20/ /opt/etcd
opt]# cd etcd
~~~

> **tag**ï¼šå¯ä»¥åŠ å…¥ï¼Œè§£å¼€å¤‡ä»½æ–‡ä»¶å†…çš„æ–‡ä»¶
>
> - **x**ï¼šè§£å‹
> - **f** ï¼šä½¿ç”¨æ¡£æ¡ˆåå­—
> - **-C**ï¼šåˆ‡æ¢åˆ°æŒ‡å®šçš„ç›®å½•
> - æ•´æ¡å‘½ä»¤åˆèµ·æ¥å°±æ˜¯ï¼ŒæŠŠtgzæ–‡ä»¶ä»¥tgzæ–‡ä»¶åä¸ºåå­—è§£å‹åˆ°optç›®å½•ä¸‹ï¼Œå¹¶ä¿å­˜tgzæ–‡ä»¶åŸæ ·
>
> **ln**ï¼šä¸ºæŸä¸€ä¸ªæ–‡ä»¶åœ¨å¦å¤–ä¸€ä¸ªä½ç½®å»ºç«‹ä¸€ä¸ªåŒæ­¥çš„é“¾æ¥
>
> - `è¯­æ³•:ln [å‚æ•°][æºæ–‡ä»¶æˆ–ç›®å½•][ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•]`
> - **-s**ï¼šè½¯è¿æ¥ï¼Œå¯ä»¥å¯¹æ•´ä¸ªç›®å½•è¿›è¡Œé“¾æ¥
>
> **useradd**ï¼šå»ºç«‹ç”¨æˆ·å¸å·
>
> **-s**ï¼šæŒ‡å®šç”¨æˆ·ç™»å…¥åæ‰€ä½¿ç”¨çš„shell
>
> **-M**ï¼šä¸è¦è‡ªåŠ¨å»ºç«‹ç”¨æˆ·çš„ç™»å…¥ç›®å½•

<img src="assets/WX20230511-194515@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 12/21/22æœºå™¨ï¼š
etcd]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server
etcd]# cd certs/
certs]# scp hdss7-200:/opt/certs/ca.pem .
# è¾“å…¥200è™šæœºå¯†ç 
certs]# scp hdss7-200:/opt/certs/etcd-peer*.pem .
certs]# cd ..
# 3å°æœºå™¨ï¼Œå¦‚æœæ˜¯21æœºå™¨ï¼Œè¿™ä¸‹é¢å¾—12éƒ½å¾—æ”¹æˆ21ï¼Œå¯¹åº”çš„ipæ¢æˆ21çš„å†…ç½‘ipï¼Œinitial-clusteråˆ™æ˜¯å…¨éƒ¨æœºå™¨éƒ½æœ‰ä¸éœ€è¦æ”¹ï¼Œä¸€å…±5å¤„ï¼šetcd-server-7-12ã€listen-peer-urlsåã€client-urlsåã€advertise-peer-urlsåã€advertise-client-urlsåï¼Œå¯ä»¥ç”¨:%s/æ—§ip/æ–°ip/gå‘½ä»¤è¿›è¡Œæ‰¹é‡æ›´æ¢(é€€å‡ºinsertåç²˜è´´)
etcd]# vi /opt/etcd/etcd-server-startup.sh
#!/bin/sh
./etcd --name etcd-server-7-12 \
       --data-dir /data/etcd/etcd-server \
       --listen-peer-urls https://172.27.139.119:2380 \
       --listen-client-urls https://172.27.139.119:2379,http://127.0.0.1:2379 \
       --quota-backend-bytes 8000000000 \
       --initial-advertise-peer-urls https://172.27.139.119:2380 \
       --advertise-client-urls https://172.27.139.119:2379,http://127.0.0.1:2379 \
       --initial-cluster  etcd-server-7-12=https://172.27.139.119:2380,etcd-server-7-21=https://172.27.139.118:2380,etcd-server-7-22=https://172.27.139.120:2380 \
       --ca-file ./certs/ca.pem \
       --cert-file ./certs/etcd-peer.pem \
       --key-file ./certs/etcd-peer-key.pem \
       --client-cert-auth  \
       --trusted-ca-file ./certs/ca.pem \
       --peer-ca-file ./certs/ca.pem \
       --peer-cert-file ./certs/etcd-peer.pem \
       --peer-key-file ./certs/etcd-peer-key.pem \
       --peer-client-cert-auth \
       --peer-trusted-ca-file ./certs/ca.pem \
       --log-output stdout

etcd]# chmod +x etcd-server-startup.sh
etcd]# chown -R etcd.etcd /opt/etcd-v3.1.20/
etcd]# chown -R etcd.etcd /data/etcd/
etcd]# chown -R etcd.etcd /data/logs/etcd-server/
etcd]# ll
~~~

> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•
>
> **å¸¦***ï¼šè¡¨ç¤ºæ¨¡ç³ŠåŒ¹é…ä»»æ„å†…å®¹
>
> **chmod**ï¼šæ·»åŠ æƒé™
>
> - **+x**ï¼šç»™å½“å‰ç”¨æˆ·æ·»åŠ å¯æ‰§è¡Œè¯¥æ–‡ä»¶çš„æƒé™æƒé™
>
> **chown**ï¼šæŒ‡å®šæ–‡ä»¶çš„æ‹¥æœ‰è€…æ”¹ä¸ºæŒ‡å®šçš„ç”¨æˆ·æˆ–ç»„
>
> - **-R**ï¼šå¤„ç†æŒ‡å®šç›®å½•ä»¥åŠå…¶å­ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
> - è¿™é‡Œå³æ˜¯æŠŠ/opt/etcd...ç­‰çš„æ‹¥æœ‰è€…ç»™etcdç”¨æˆ·
>
> **ll**ï¼šåˆ—å‡ºæƒé™ã€å¤§å°ã€åç§°ç­‰ä¿¡æ¯

<img src="assets/WX20230512-105320@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 12/21/22æœºå™¨ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦supervisorï¼ˆå®ˆæŠ¤è¿›ç¨‹å·¥å…·ï¼‰æ¥ç¡®ä¿etcdæ˜¯å¯åŠ¨çš„ï¼Œåé¢è¿˜ä¼šä¸æ–­ç”¨åˆ°ï¼š
# è¿™ä¸ªæˆ‘ä»¬å‰é¢å·²ç»è£…äº† yum install supervisor -y
etcd]# systemctl start supervisord
etcd]# systemctl enable supervisord
# æ³¨æ„ä¿®æ”¹ä¸‹é¢å¾—7-12ï¼Œå¯¹åº”ä¸Šæœºå™¨ï¼Œå¦‚21æœºå™¨å°±æ˜¯7-21ï¼Œä¸€å…±ä¸€å¤„ï¼š[program:etcd-server-7-12]
etcd]# vi /etc/supervisord.d/etcd-server.ini
[program:etcd-server-7-12]
command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)
numprocs=1                                                      ; number of processes copies to start (def 1)
directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)
autostart=true                                                  ; start at supervisord start (default: true)
autorestart=true                                                ; retstart at unexpected quit (default: true)
startsecs=30                                                    ; number of secs prog must stay running (def. 1)
startretries=3                                                  ; max # of serial start failures (default 3)
exitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)
stopsignal=QUIT                                                 ; signal used to kill process (default TERM)
stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)
user=etcd                                                       ; setuid to this UNIX account to run the program
redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)
stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO
stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)
stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)
stdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)
stdout_events_enabled=false                                     ; emit events on stdout writes (default false)

etcd]# supervisorctl update
# outï¼šetcd-server-7-21: added process group
etcd]# supervisorctl status
# out: etcd-server-7-12                 RUNNING   pid 16582, uptime 0:00:59
etcd]# netstat -luntp|grep etcd
# å¿…é¡»æ˜¯ç›‘å¬äº†2379å’Œ2380è¿™ä¸¤ä¸ªç«¯å£æ‰ç®—æˆåŠŸ
tcp        0      0 172.27.139.119:2379     0.0.0.0:*               LISTEN      14903/./etcd        
tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      14903/./etcd        
tcp        0      0 172.27.139.119:2380     0.0.0.0:*               LISTEN      14903/./etcd 
~~~

> **systemctl enable**ï¼šå¼€æœºå¯åŠ¨
>
> **update**ï¼šæ›´æ–°
>
> **netstat -luntpï¼š**æŸ¥çœ‹ç«¯å£å’Œè¿›ç¨‹æƒ…å†µ
>
> ç°åœ¨ä½ å¯ä»¥æ„Ÿè§‰åˆ°ï¼Œsupervisorå®ˆæŠ¤è¿›ç¨‹ä¹Ÿä»…ä»…æ˜¯ä½ é…å¥½iniæ–‡ä»¶å³å¯

~~~
# ä»»æ„èŠ‚ç‚¹ï¼ˆ12/21/22ï¼‰æ£€æµ‹é›†ç¾¤å¥åº·çŠ¶æ€çš„ä¸¤ç§æ–¹æ³•
22 etcd]# ./etcdctl cluster-health
22 etcd]# ./etcdctl member list
~~~

<img src="assets/WX20230512-154055@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

> è¿™é‡Œä½ å†å“ªä¸ªæœºå™¨å…ˆupdateï¼Œå“ªä¸ªæœºå™¨å°±æ˜¯leader

å®Œæˆ



### éƒ¨ç½²API-serveré›†ç¾¤

[kuberneteså®˜ç½‘](https://github.com/kubernetes/kubernetes)

æ ¹æ®æ¶æ„å›¾ï¼Œæˆ‘ä»¬æŠŠè¿ç®—èŠ‚ç‚¹éƒ¨ç½²åœ¨21å’Œ22æœºå™¨

![1584701070750](assets/1584701070750.png)

~~~
# 21/22æœºå™¨
etcd]# cd /opt/src/
# å¯ä»¥å»å®˜ç½‘ä¸‹è½½ä¹Ÿå¯ä»¥ç”¨æˆ‘çš„åŒ…ï¼Œç™¾åº¦äº‘ç›˜https://pan.baidu.com/s/1arE2LdtAbcR80gmIQtIELw æå–ç ï¼šouy1
src]# wget https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz
src]# mv kubernetes-server-linux-amd64.tar.gz kubernetes-server-linux-amd64-v1.15.2.tar.gz

src]# tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C /opt/
src]# cd /opt
opt]# mv kubernetes/ kubernetes-v1.15.2
opt]# ln -s /opt/kubernetes-v1.15.2/ /opt/kubernetes
opt]# cd kubernetes
# åˆ æ‰ä¸éœ€è¦çš„æ–‡ä»¶
kubernetes]# rm -rf kubernetes-src.tar.gz
kubernetes]# cd server/bin
bin]# rm -f *.tar
bin]# rm -f *_tag
bin]# ll
~~~

> **tar xf -C**ï¼šè§£å‹åˆ°æŸä¸ªæ–‡ä»¶å¤¹
>
> **mv**ï¼šç§»åŠ¨åˆ°å“ªé‡Œ
>
> **ln -s**ï¼šå»ºç«‹è½¯è¿æ¥
>
> **rm**ï¼šåˆ é™¤ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•
>
> - **-r**ï¼šå°†ç›®å½•åŠä»¥ä¸‹ä¹‹æ¡£æ¡ˆäº¦é€ä¸€åˆ é™¤
> - **-f**ï¼šç›´æ¥åˆ é™¤ï¼Œæ— éœ€é€ä¸€ç¡®è®¤ï¼ˆä½ å¯ä»¥è¯•è¯•å…ˆä¸åŠ -få»åˆ é™¤ï¼‰
> - åŠ èµ·æ¥å°±æ˜¯å¼ºåˆ¶åˆ é™¤
>
> ***.tar**ï¼š è¿™é‡Œçš„*çš„æ„æ€æ˜¯æ¨¡ç³Šæ³•ï¼Œå³åªè¦ä½ çš„ç»“å°¾æ˜¯.tarçš„éƒ½åŒ¹é…ä¸ŠåŠ ä¸Šrmï¼Œå°±æ˜¯æŠŠæ‰€æœ‰.tarç»“å°¾çš„æ–‡ä»¶éƒ½åˆ é™¤

<img src="assets/WX20230512-113733@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 200æœºå™¨ï¼Œç­¾å‘clientè¯ä¹¦ï¼š
200 ~]# cd /opt/certs/
200 certs]# vi client-csr.json
{
    "CN": "k8s-node",
    "hosts": [
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ]
}

200 certs]#  cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json |cfssl-json -bare client
200 certs]# ll
~~~

<img src="assets/WX20230512-133747@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 200æœºå™¨ï¼Œç»™API-serveråšè¯ä¹¦ï¼Œå…¶ä¸­"127.0.0.1"å’Œ"192.168.0.1"ä¸å˜ï¼Œä¸‹é¢4ä¸ªipåˆ†åˆ«æ˜¯å½“å‰ç½‘æ®µ.10åšè™šæ‹Ÿvipã€21æœºå™¨ipã€22æœºå™¨ipä»¥åŠé¢„ç•™çš„23æœºå™¨ipï¼ˆåç»­å¦‚æœéœ€è¦åˆ™æ‰©å®¹ï¼Œä¹Ÿå¯ä»¥ä¸å¡«ï¼‰
200 certs]# vi apiserver-csr.json
{
    "CN": "k8s-apiserver",
    "hosts": [
        "127.0.0.1",
        "192.168.0.1",
        "kubernetes.default",
        "kubernetes.default.svc",
        "kubernetes.default.svc.cluster",
        "kubernetes.default.svc.cluster.local",
        "172.27.139.10",
        "172.27.139.118",
        "172.27.139.120",
        "172.27.139.123"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ]
}

200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json |cfssl-json -bare apiserver
200 certs]# ll
~~~

> è¯·ç¡®ä¿ä½œä¸ºè™šæ‹Ÿvip172.27.139.10å¹¶ä¸çœŸå®å­˜åœ¨ï¼Œping 172.27.139.10åº”è¯¥æ˜¯ä¸é€šçš„

<img src="assets/WX20230512-141539@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

~~~
# 21/22æœºå™¨ï¼š
cd /opt/kubernetes/server/bin
bin]# mkdir cert
bin]# cd cert/
# æŠŠè¯ä¹¦è€ƒè¿‡æ¥ï¼Œä¸€å…±6ä¸ª
cert]# scp hdss7-200:/opt/certs/c*.pem .
cert]# scp hdss7-200:/opt/certs/apiserver*.pem .
~~~

> **scp**ï¼šç”¨äº *Linux* ä¹‹é—´å¤åˆ¶æ–‡ä»¶å’Œç›®å½•
>
> **å¸¦***ï¼šè¡¨ç¤ºæ¨¡ç³ŠåŒ¹é…ä»»æ„å†…å®¹

~~~
# 21/22æœºå™¨ï¼š
cert]# ll
total 24
-rw------- 1 root root 1675 May 12 14:22 apiserver-key.pem
-rw-r--r-- 1 root root 1602 May 12 14:22 apiserver.pem
-rw------- 1 root root 1679 May 12 14:24 ca-key.pem
-rw-r--r-- 1 root root 1346 May 12 14:24 ca.pem
-rw------- 1 root root 1675 May 12 14:24 client-key.pem
-rw-r--r-- 1 root root 1367 May 12 14:24 client.pem
cert]# pwd
/opt/kubernetes/server/bin/cert
~~~

~~~
# 21/22æœºå™¨ï¼š
cd /opt/kubernetes/server/bin
bin]# mkdir conf
bin]# cd conf/
conf]# vi audit.yaml
apiVersion: audit.k8s.io/v1beta1 # This is required.
kind: Policy
# Don't generate audit events for all requests in RequestReceived stage.
omitStages:
  - "RequestReceived"
rules:
  # Log pod changes at RequestResponse level
  - level: RequestResponse
    resources:
    - group: ""
      # Resource "pods" doesn't match requests to any subresource of pods,
      # which is consistent with the RBAC policy.
      resources: ["pods"]
  # Log "pods/log", "pods/status" at Metadata level
  - level: Metadata
    resources:
    - group: ""
      resources: ["pods/log", "pods/status"]

  # Don't log requests to a configmap called "controller-leader"
  - level: None
    resources:
    - group: ""
      resources: ["configmaps"]
      resourceNames: ["controller-leader"]

  # Don't log watch requests by the "system:kube-proxy" on endpoints or services
  - level: None
    users: ["system:kube-proxy"]
    verbs: ["watch"]
    resources:
    - group: "" # core API group
      resources: ["endpoints", "services"]

  # Don't log authenticated requests to certain non-resource URL paths.
  - level: None
    userGroups: ["system:authenticated"]
    nonResourceURLs:
    - "/api*" # Wildcard matching.
    - "/version"

  # Log the request body of configmap changes in kube-system.
  - level: Request
    resources:
    - group: "" # core API group
      resources: ["configmaps"]
    # This rule only applies to resources in the "kube-system" namespace.
    # The empty string "" can be used to select non-namespaced resources.
    namespaces: ["kube-system"]

  # Log configmap and secret changes in all other namespaces at the Metadata level.
  - level: Metadata
    resources:
    - group: "" # core API group
      resources: ["secrets", "configmaps"]

  # Log all other resources in core and extensions at the Request level.
  - level: Request
    resources:
    - group: "" # core API group
    - group: "extensions" # Version of group should NOT be included.

  # A catch-all rule to log all other requests at the Metadata level.
  - level: Metadata
    # Long-running requests like watches that fall under this rule will not
    # generate an audit event in RequestReceived.
    omitStages:
      - "RequestReceived"
      
conf]# cd ..
# ä¸‹é¢æœ‰3å¤„ipéœ€è¦æ”¹ï¼Œ--etcd-serversåˆ†åˆ«æ”¹æˆ12ã€21ã€22æœºå™¨çš„IP
bin]# vi /opt/kubernetes/server/bin/kube-apiserver.sh
#!/bin/bash
./kube-apiserver \
  --apiserver-count 2 \
  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \
  --audit-policy-file ./conf/audit.yaml \
  --authorization-mode RBAC \
  --client-ca-file ./cert/ca.pem \
  --requestheader-client-ca-file ./cert/ca.pem \
  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \
  --etcd-cafile ./cert/ca.pem \
  --etcd-certfile ./cert/client.pem \
  --etcd-keyfile ./cert/client-key.pem \
  --etcd-servers https://172.27.139.119:2379,https://172.27.139.118:2379,https://172.27.139.120:2379 \
  --service-account-key-file ./cert/ca-key.pem \
  --service-cluster-ip-range 192.168.0.0/16 \
  --service-node-port-range 3000-29999 \
  --target-ram-mb=1024 \
  --kubelet-client-certificate ./cert/client.pem \
  --kubelet-client-key ./cert/client-key.pem \
  --log-dir  /data/logs/kubernetes/kube-apiserver \
  --tls-cert-file ./cert/apiserver.pem \
  --tls-private-key-file ./cert/apiserver-key.pem \
  --v 2
  
bin]# chmod +x kube-apiserver.sh
# ä¸€å¤„ä¿®æ”¹ï¼š[program:kube-apiserver-7-21]ï¼Œ22æœºå™¨åˆ™æ”¹æˆ7-22
bin]# vi /etc/supervisord.d/kube-apiserver.ini
[program:kube-apiserver-7-21]
command=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)
numprocs=1                                                      ; number of processes copies to start (def 1)
directory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)
autostart=true                                                  ; start at supervisord start (default: true)
autorestart=true                                                ; retstart at unexpected quit (default: true)
startsecs=30                                                    ; number of secs prog must stay running (def. 1)
startretries=3                                                  ; max # of serial start failures (default 3)
exitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)
stopsignal=QUIT                                                 ; signal used to kill process (default TERM)
stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)
user=root                                                       ; setuid to this UNIX account to run the program
redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)
stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO
stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)
stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)
stdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)
stdout_events_enabled=false                                     ; emit events on stdout writes (default false)

bin]# mkdir -p /data/logs/kubernetes/kube-apiserver
bin]# supervisorctl update
# æŸ¥çœ‹21/22ä¸¤å°æœºå™¨æ˜¯å¦è·‘èµ·æ¥äº†ï¼Œå¯èƒ½æ¯”è¾ƒæ…¢åœ¨STARTINGï¼Œç­‰10ç§’
bin]# supervisorctl status
~~~

> **mkdir -p**ï¼šåˆ›å»ºç›®å½•ï¼Œæ²¡æœ‰ä¸Šä¸€çº§ç›®å½•åˆ™åˆ›å»º
>
> **supervisorctl update**ï¼šæ›´æ–°supervisorctl
>
> **audit.yamlè§£æï¼š**
>
> - å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« [ç‚¹å‡»è·³è½¬](https://www.baidu.com/link?url=tFECOG31lKlcqDWeAZGF1VyjhzVAN9vUKHKEKKw5G8y0AC8MKpJxSZeL647MIFdw&wd=&eqid=dafe84b80019e4a3000000065e51d2e2)ï¼Œå½“ç„¶è¿™é‡Œçš„audit.yamlå¯èƒ½ä¼šæœ‰äº›ä¸ä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢ç”¨åˆ°çš„yamlæ–‡ä»¶å°±å¾ˆç›¸ä¼¼äº†

<img src="assets/WX20230512-143347@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

> <a href="https://github.com/ben1234560/k8s_PaaS/blob/master/%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/Kubernetes%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.md#pod%E7%9A%84%E5%87%A0%E7%A7%8D%E7%8A%B6%E6%80%81">Podçš„å‡ ç§çŠ¶æ€</a>

å®Œæˆ



### å®‰è£…éƒ¨ç½²ä¸»æ§èŠ‚ç‚¹L4åä»£æœåŠ¡

æ ¹æ®æˆ‘ä»¬æ¶æ„å›¾ï¼Œåœ¨11/12æœºå™¨ä¸Šåšåä»£

![1584701103579](assets/1584701103579.png)

å®‰è£…nginxæ—¶å¦ä¸€ä¸ªæ³¨æ„äº‹é¡¹ <a href="https://github.com/ben1234560/k8s_PaaS/issues/16">ç‚¹å‡»é“¾æ¥Â Â </a>

ï¼ˆæ„Ÿè°¢ https://github.com/nangongchengfeng/ï¼‰

~~~
# 11/12æœºå™¨åŠ21/22æœºå™¨ï¼ˆè€ƒè™‘åˆ°å…¬æœ‰äº‘çš„ç½‘ç»œæƒ…å†µï¼Œæˆ‘ä»¬å°†21/22æœºå™¨åŒæ—¶ä¹Ÿä½œä¸ºå¤‡åä»£èŠ‚ç‚¹ï¼‰
# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install nginx nginx-mod-stream -y
# æ·»åŠ åœ¨æœ€ä¸‹é¢ï¼Œserverå¤„éœ€è¦æ”¹æˆè‡ªå·±çš„21ã€22æœºå™¨IP
~]# vi /etc/nginx/nginx.conf
stream {
    upstream kube-apiserver {
        server 172.27.139.118:6443     max_fails=3 fail_timeout=30s;
        server 172.27.139.120:6443     max_fails=3 fail_timeout=30s;
    }
    server {
        listen 7443;
        proxy_connect_timeout 2s;
        proxy_timeout 900s;
        proxy_pass kube-apiserver;
    }
}

~]# nginx -t
~]# systemctl start nginx
~]# systemctl enable nginx

# è¿™ä¸ªå‰é¢å·²ç»å®‰è£… yum install keepalived -y
# keepalived ç›‘æ§ç«¯å£è„šæœ¬
~]# vi /etc/keepalived/check_port.sh
#!/bin/bash
CHK_PORT=$1
if [ -n "$CHK_PORT" ];then
        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`
        if [ $PORT_PROCESS -eq 0 ];then
                echo "Port $CHK_PORT Is Not Used,End."
                exit 1
        fi
else
        echo "Check Port Cant Be Empty!"
fi

~]# chmod +x /etc/keepalived/check_port.sh
~~~

> ç”±äº7443ç«¯å£æœªç›‘å¬ï¼ŒNginx å¯åŠ¨æŠ¥ [emerg] bind() failedçš„å¯ä»¥å‚è€ƒ[è¿™ä¸ªæ–¹æ³•](https://blog.csdn.net/RunSnail2018/article/details/81185138)ï¼ˆæ„Ÿè°¢https://gitee.com/wangming91/ï¼‰
>
> ä¸Šè¿°ä»£ç è§£æï¼š`upstream` å—ï¼šå®šä¹‰äº†åä¸º `kube-apiserver` çš„ä¸Šæ¸¸æœåŠ¡å™¨ç»„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯¥ç»„ç”±ä¸¤ä¸ªæœåŠ¡å™¨ç»„æˆï¼ŒæŒ‡å®šäº†ä¸Šæ¸¸æœåŠ¡å™¨çš„ IP åœ°å€å’Œç«¯å£ã€‚`server` å—ï¼šå®šä¹‰äº†ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œå®ƒç›‘å¬æœ¬åœ°ç«¯å£ `7443`ï¼Œå¹¶å°†è¯·æ±‚ä»£ç†åˆ°ä¸Šæ¸¸æœåŠ¡å™¨ç»„ `kube-apiserver`
>
> é€šè¿‡è¿™ä¸ªé…ç½®ï¼Œå½“æœ‰è¯·æ±‚å‘é€åˆ°ä»£ç†æœåŠ¡å™¨çš„ `7443` ç«¯å£æ—¶ï¼ŒNginx å°†ä¼šå°†è¯·æ±‚è½¬å‘åˆ° `kube-apiserver` ä¸Šæ¸¸æœåŠ¡å™¨ç»„ä¸­çš„ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè¿›è¡Œå¤„ç†ã€‚è¿™å¯ä»¥ç”¨äºä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯¹ `kube-apiserver` çš„è¯·æ±‚ã€‚
>
> **yum install -y**ï¼šå®‰è£…å¹¶è‡ªåŠ¨yes
>
> **nginx -t**ï¼šç¡®å®šnginx.confæœ‰æ²¡æœ‰è¯­æ³•é”™è¯¯
>
> **systemctl start**ï¼šå¯åŠ¨æœåŠ¡
>
> **systemctl enable**ï¼šå¼€æœºè‡ªå¯

~~~
# ä»…ä»¥ä¸‹åˆ†ä¸»ä»æ“ä½œï¼š
# æŠŠåŸæœ‰å†…å®¹éƒ½åˆ æ‰ï¼Œå‘½ä»¤è¡Œå¿«é€ŸæŒ‰æ‰“å‡ºdG
# æ³¨æ„ï¼Œä¸‹é¢çš„vrrp_instanceä¸‹çš„interfaceï¼Œæˆ‘çš„æœºå™¨æ˜¯eth0é…ç½®äº†ç½‘å¡ï¼Œæœ‰çš„ç‰ˆæœ¬æ˜¯ens33é…ç½®ç½‘å¡ï¼Œå¯ä»¥ç”¨ifconfigæŸ¥çœ‹ï¼Œç¬¬ä¸€è¡Œå°±æ˜¯ï¼Œå¦‚æœä½ æ˜¯ens33ï¼Œæ”¹è¿™ä¸ªinterface ens33
# keepalived ä¸»ï¼ˆå³11æœºå™¨ï¼‰ï¼Œä¿®æ”¹router_idã€mcast_src_ipä¸¤å¤„ä¸º11æœºå™¨çš„ipï¼Œä¿®æ”¹virtual_ipaddressä¸ºè™šæ‹Ÿvip 10:
11 ~]# vi /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 172.27.139.122

}

vrrp_script chk_nginx {
    script "/etc/keepalived/check_port.sh 7443"
    interval 2
    weight -20
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 251
    priority 100
    advert_int 1
    mcast_src_ip 172.27.139.122
    nopreempt

    authentication {
        auth_type PASS
        auth_pass 11111111
    }
    track_script {
         chk_nginx
    }
    virtual_ipaddress {
        172.27.139.10
    }
}

# keepalivedä»ï¼ˆå³12/21/22æœºå™¨ï¼‰ï¼Œä¿®æ”¹router_idã€mcast_src_ipä¸¤å¤„ä¸º12æˆ–21æˆ–22æœºå™¨çš„ipï¼Œä¿®æ”¹virtual_ipaddressä¸ºè™šæ‹Ÿvip 10:
12/21/22 ~]# vi /etc/keepalived/keepalived.conf
! Configuration File for keepalived
global_defs {
	router_id 172.27.139.119
}
vrrp_script chk_nginx {
	script "/etc/keepalived/check_port.sh 7443"
	interval 2
	weight -20
}
vrrp_instance VI_1 {
	state BACKUP
	interface eth0
	virtual_router_id 251
	mcast_src_ip 172.27.139.119
	priority 90
	advert_int 1
	authentication {
		auth_type PASS
		auth_pass 11111111
	}
	track_script {
		chk_nginx
	}
	virtual_ipaddress {
		172.27.139.10
	}
}
~~~

å¯åŠ¨keepalived

~~~
# 11/12/21/22æœºå™¨
~]# systemctl start keepalived
~]# systemctl enable keepalived
# åœ¨11/12/21/22æœºå™¨
11 ~]# ip add
~~~

<img src="assets/WX20230512-144506@2x.png" alt="image-å®æ“å›¾" align="left" style="zoom:50%;" />

ç¡®ä¿21/22æœºå™¨èƒ½å¤Ÿtelneté€šè™šæ‹Ÿvip 10çš„7443ç«¯å£

~~~
21 ~]# telnet 172.27.139.10 7443
Trying 172.27.139.10...
Connected to 172.27.139.10.
Escape character is '^]'.

22 ~]# telnet 172.27.139.10 7443
Trying 172.27.139.10...
Connected to 172.27.139.10.
Escape character is '^]'.
~~~

å®Œæˆ



### å®‰è£…éƒ¨ç½²controller-managerï¼ˆèŠ‚ç‚¹æ§åˆ¶å™¨/è°ƒåº¦å™¨æœåŠ¡ï¼‰

è®©æˆ‘ä»¬å†æ¬å‡ºæˆ‘ä»¬çš„æ¶æ„å›¾

![1584701137068](assets/1584701137068.png)

~~~
# 21/22æœºå™¨ï¼š
bin]# vi /opt/kubernetes/server/bin/kube-controller-manager.sh
#!/bin/sh
./kube-controller-manager \
  --cluster-cidr 172.7.0.0/16 \
  --leader-elect true \
  --log-dir /data/logs/kubernetes/kube-controller-manager \
  --master http://127.0.0.1:8080 \
  --service-account-private-key-file ./cert/ca-key.pem \
  --service-cluster-ip-range 192.168.0.0/16 \
  --root-ca-file ./cert/ca.pem \
  --v 2

bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh
bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager
# æ³¨æ„22æœºå™¨ï¼Œä¸‹é¢è¦æ”¹æˆ7-22ï¼Œä¸€å¤„ä¿®æ”¹ï¼šmanager-7-21]
bin]# vi /etc/supervisord.d/kube-conntroller-manager.ini
[program:kube-controller-manager-7-21]
command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)
numprocs=1                                                                        ; number of processes copies to start (def 1)
directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)
autostart=true                                                                    ; start at supervisord start (default: true)
autorestart=true                                                                  ; retstart at unexpected quit (default: true)
startsecs=30                                                                      ; number of secs prog must stay running (def. 1)
startretries=3                                                                    ; max # of serial start failures (default 3)
exitcodes=0,2                                                                     ; 'expected' exit codes for process (default 0,2)
stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)
stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)
user=root                                                                         ; setuid to this UNIX account to run the program
redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)
stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO
stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)
stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)
stdout_capture_maxbytes=1MB                                                       ; number of bytes in 'capturemode' (default 0)
stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)

bin]# supervisorctl update
bin]# vi /opt/kubernetes/server/bin/kube-scheduler.sh
#!/bin/sh
./kube-scheduler \
  --leader-elect  \
  --log-dir /data/logs/kubernetes/kube-scheduler \
  --master http://127.0.0.1:8080 \
  --v 2
  
bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh
bin]# mkdir -p /data/logs/kubernetes/kube-scheduler
# æ³¨æ„æ”¹æœºå™¨å·ï¼Œä¸€å¤„ä¿®æ”¹ï¼šscheduler-7-21]
bin]# vi /etc/supervisord.d/kube-scheduler.ini
[program:kube-scheduler-7-21]
command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)
numprocs=1                                                               ; number of processes copies to start (def 1)
directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)
autostart=true                                                           ; start at supervisord start (default: true)
autorestart=true                                                         ; retstart at unexpected quit (default: true)
startsecs=30                                                             ; number of secs prog must stay running (def. 1)
startretries=3                                                           ; max # of serial start failures (default 3)
exitcodes=0,2                                                            ; 'expected' exit codes for process (default 0,2)
stopsignal=QUIT                                                          ; signal used to kill process (default TERM)
stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)
user=root                                                                ; setuid to this UNIX account to run the program
redirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)
stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO
stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)
stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)
stdout_capture_maxbytes=1MB                                              ; number of bytes in 'capturemode' (default 0)
stdout_events_enabled=false                                              ; emit events on stdout writes (default false)

bin]# supervisorctl update
bin]# supervisorctl status
etcd-server-7-21                 RUNNING   pid 14765, uptime 4:30:28
kube-apiserver-7-21              RUNNING   pid 16088, uptime 0:53:15
kube-controller-manager-7-21     RUNNING   pid 18734, uptime 0:01:56
kube-scheduler-7-21              RUNNING   pid 18958, uptime 0:00:47

bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl
# æŸ¥çœ‹é›†ç¾¤å¥åº·æƒ…å†µï¼Œ21/22æœºå™¨ï¼š
bin]# kubectl get cs
NAME                 STATUS    MESSAGE              ERROR
scheduler            Healthy   ok                   
controller-manager   Healthy   ok                   
etcd-2               Healthy   {"health": "true"}   
etcd-1               Healthy   {"health": "true"}   
etcd-0               Healthy   {"health": "true"} 
~~~

> **ln -s**ï¼šå»ºç«‹è½¯é“¾æ¥
>
> **supervisorctl status**ï¼šæŸ¥çœ‹supervisorçš„æƒ…å†µ
>
> **supervisorctl update**ï¼šæ›´æ–°supervisor
>
> **kubectl get**ï¼šè·å–åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºçš„ä¿¡æ¯
>
> - ä¸Šé¢ä¸€æ¡å‘½ä»¤çš„æ„æ€æ˜¯ï¼š    åˆ—å‡ºæ‰€æœ‰csä¿¡æ¯

å®Œæˆ



